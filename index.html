<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Potato Farming and Tracking Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles: Field Almanac UI */
        @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@500;700;800&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap');
        :root {
            --font-display: 'Fraunces', serif;
            --font-body: 'IBM Plex Sans', sans-serif;
            --color-ink: #2a241c;
            --color-primary: #d45b2b;
            --color-primary-dark: #b3471f;
            --color-secondary: #f1c453;
            --color-secondary-dark: #c99e39;
            --color-tertiary: #2a7d73;
            --color-tertiary-dark: #1f5f58;
            --color-accent: #3f7c4b;
            --color-accent-dark: #2f5f39;
            --color-card: #fffaf2;
            --color-bg: #f4efe5;
            --color-muted: #6b655d;
            --shadow-strong: 12px 12px 0 rgba(33, 30, 24, 0.14);
            --shadow-soft: 4px 4px 0 rgba(33, 30, 24, 0.12);
            --radius-lg: 18px;
            --radius-md: 12px;
        }
        * {
            box-sizing: border-box;
        }
        body {
            background:
                radial-gradient(circle at top left, #fff4d8 0%, rgba(255, 244, 216, 0) 45%),
                radial-gradient(circle at 85% 20%, #e7f4ea 0%, rgba(231, 244, 234, 0) 40%),
                linear-gradient(120deg, #f7efe2 0%, #f3f0e6 45%, #eef4ee 100%);
            color: var(--color-ink);
            font-family: var(--font-body);
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(rgba(42, 36, 28, 0.08) 1px, transparent 0),
                radial-gradient(rgba(42, 36, 28, 0.04) 1px, transparent 0);
            background-size: 28px 28px, 6px 6px;
            background-position: 0 0, 12px 12px;
            opacity: 0.35;
            pointer-events: none;
        }
        h1, h2, h3, h4, h5 {
            font-family: var(--font-display);
            letter-spacing: -0.01em;
        }
        .guide-card {
            background: linear-gradient(180deg, #fffdf7 0%, #fff5e8 100%);
            border: 4px solid var(--color-ink);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-strong);
            position: relative;
            overflow: hidden;
            animation: rise-in 0.6s ease-out;
        }
        .guide-card::after {
            content: '';
            position: absolute;
            inset: 12px;
            border: 2px dashed rgba(42, 36, 28, 0.08);
            border-radius: calc(var(--radius-lg) - 10px);
            pointer-events: none;
        }
        .header-stack > * {
            animation: rise-in 0.6s ease-out both;
        }
        .header-stack > *:nth-child(1) { animation-delay: 0.05s; }
        .header-stack > *:nth-child(2) { animation-delay: 0.1s; }
        .header-stack > *:nth-child(3) { animation-delay: 0.15s; }
        .header-stack > *:nth-child(4) { animation-delay: 0.2s; }
        @keyframes rise-in {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .tab-btn {
            width: 100%;
            border-radius: 14px;
            border: 2px solid rgba(42, 36, 28, 0.2);
            background: rgba(255, 255, 255, 0.75);
            color: var(--color-ink);
            font-size: 0.875rem;
            font-weight: 700;
            padding: 0.6rem 1rem;
            box-shadow: 2px 2px 0 rgba(42, 36, 28, 0.15);
            transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease, color 0.12s ease, border-color 0.12s ease;
        }
        .tab-btn:hover {
            transform: translateY(-1px);
            box-shadow: 3px 3px 0 rgba(42, 36, 28, 0.2);
        }
        .tab-btn.is-active {
            background: var(--color-primary);
            border-color: var(--color-primary-dark);
            color: #fff7f0;
            box-shadow: 4px 4px 0 var(--color-primary-dark);
        }
        .tab-btn[data-accent="sun"].is-active {
            background: var(--color-secondary);
            border-color: var(--color-secondary-dark);
            color: #3b2a14;
        }
        .tab-btn[data-accent="leaf"].is-active {
            background: var(--color-accent);
            border-color: var(--color-accent-dark);
            color: #ecfff1;
        }
        .tab-btn[data-accent="river"].is-active {
            background: var(--color-tertiary);
            border-color: var(--color-tertiary-dark);
            color: #e9fffb;
        }
        .btn-primary,
        .btn-secondary,
        .btn-tertiary {
            --btn-bg: var(--color-primary);
            --btn-shadow: var(--color-primary-dark);
            --btn-color: #fff7f0;
            background-color: var(--btn-bg);
            border: 3px solid var(--btn-shadow);
            color: var(--btn-color);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
            box-shadow: 4px 4px 0 var(--btn-shadow);
        }
        .btn-secondary {
            --btn-bg: var(--color-secondary);
            --btn-shadow: var(--color-secondary-dark);
            --btn-color: #3b2a14;
        }
        .btn-tertiary {
            --btn-bg: var(--color-tertiary);
            --btn-shadow: var(--color-tertiary-dark);
            --btn-color: #e9fffb;
        }
        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-tertiary:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0 var(--btn-shadow);
            filter: saturate(1.05);
        }
        .btn-primary:active,
        .btn-secondary:active,
        .btn-tertiary:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 var(--btn-shadow);
        }
        .btn-primary:focus-visible,
        .btn-secondary:focus-visible,
        .btn-tertiary:focus-visible,
        .tab-btn:focus-visible,
        .link-btn:focus-visible {
            outline: 3px solid rgba(42, 36, 28, 0.35);
            outline-offset: 2px;
        }
        .step-content {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom Colors for Activity Types */
        .color-green { border-color: #3f7c4b; background-color: #e7f4ea; }
        .color-orange { border-color: #d45b2b; background-color: #fde8d8; }
        .color-blue { border-color: #2a6fb0; background-color: #e2effb; }
        .color-brown { border-color: #7a4c2b; background-color: #f1e3d7; }
        .color-gray { border-color: #9c8f7b; background-color: #f3efe8; }

        .tool-panel {
            background: rgba(255, 248, 235, 0.9);
            border: 2px solid rgba(42, 36, 28, 0.18);
            box-shadow: var(--shadow-soft);
        }
        .activity-log-card {
            box-shadow: var(--shadow-soft);
        }
        .log-entry-card {
            box-shadow: 2px 2px 0 rgba(42, 36, 28, 0.08);
        }
        .link-btn {
            background-color: rgba(42, 36, 28, 0.06);
            color: var(--color-ink);
            border: 1px solid rgba(42, 36, 28, 0.2);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.1s ease, transform 0.1s ease;
        }
        .link-btn:hover {
            background-color: rgba(42, 36, 28, 0.12);
            transform: translateY(-1px);
        }
        .progress-track {
            background: linear-gradient(90deg, #f3e3c2, #f5f1e6);
            border: 2px solid rgba(42, 36, 28, 0.12);
        }
        .progress-fill {
            background: linear-gradient(90deg, #f1c453, #d45b2b);
        }
        input, textarea, select {
            background-color: #fff;
        }
        input:focus,
        textarea:focus,
        select:focus {
            outline: 3px solid rgba(42, 36, 28, 0.2);
            outline-offset: 1px;
        }
        .calendar-grid {
            display: grid;
            gap: 1.25rem;
        }
        .calendar-month {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(42, 36, 28, 0.15);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            box-shadow: var(--shadow-soft);
        }
        .calendar-month-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.45rem;
        }
        .day-name {
            font-size: 0.65rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--color-muted);
            text-align: center;
            font-weight: 700;
        }
        .day-cell {
            min-height: 92px;
            background: #fffdf7;
            border: 1px solid rgba(42, 36, 28, 0.12);
            border-radius: 10px;
            padding: 0.35rem 0.45rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .day-cell.is-empty {
            background: transparent;
            border-color: transparent;
            box-shadow: none;
        }
        .day-cell.is-today {
            border-color: var(--color-tertiary);
            box-shadow: 0 0 0 2px rgba(42, 125, 115, 0.18);
        }
        .day-cell.is-planting {
            background: #fff3d6;
            border-color: var(--color-secondary);
        }
        .day-number {
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--color-ink);
        }
        .event-stack {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .calendar-event {
            font-size: 0.68rem;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            cursor: pointer;
            text-align: left;
            appearance: none;
            background: transparent;
        }
        .calendar-more {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--color-muted);
        }
        .calendar-event .event-tooltip {
            position: absolute;
            left: 0;
            top: calc(100% + 6px);
            z-index: 20;
            min-width: 180px;
            max-width: 240px;
            background: #2a241c;
            color: #fff7f0;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            line-height: 1.35;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            pointer-events: none;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
        }
        .calendar-event .event-tooltip::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 14px;
            width: 12px;
            height: 12px;
            background: #2a241c;
            transform: rotate(45deg);
        }
        .calendar-event:hover .event-tooltip,
        .calendar-event:focus-visible .event-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        .calendar-event.planned {
            background: rgba(255, 255, 255, 0.7);
        }
        .calendar-event.completed {
            color: #fff;
        }
        .event-orange {
            border-color: #d45b2b;
            color: #7a3418;
            background: #fde8d8;
        }
        .calendar-event.completed.event-orange {
            background: #d45b2b;
            color: #fff;
        }
        .event-blue {
            border-color: #2a6fb0;
            color: #18416c;
            background: #e2effb;
        }
        .calendar-event.completed.event-blue {
            background: #2a6fb0;
            color: #fff;
        }
        .event-green {
            border-color: #3f7c4b;
            color: #264c2f;
            background: #e7f4ea;
        }
        .calendar-event.completed.event-green {
            background: #3f7c4b;
            color: #fff;
        }
        .event-brown {
            border-color: #7a4c2b;
            color: #4a2f1a;
            background: #f1e3d7;
        }
        .calendar-event.completed.event-brown {
            background: #7a4c2b;
            color: #fff;
        }
        .event-gray {
            border-color: #9c8f7b;
            color: #5b5146;
            background: #f3efe8;
        }
        .calendar-event.completed.event-gray {
            background: #9c8f7b;
            color: #fff;
        }
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--color-muted);
        }
        .legend-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(42, 36, 28, 0.15);
            background: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            color: var(--color-ink);
        }
        .legend-planned {
            border-style: dashed;
        }
        .legend-completed {
            background: var(--color-ink);
            color: #fff;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid rgba(42, 36, 28, 0.2);
            display: inline-block;
        }
        .planner-filters {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(42, 36, 28, 0.12);
            border-radius: 12px;
            padding: 0.75rem;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        .filter-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-muted);
            margin-right: 0.25rem;
        }
        .filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(42, 36, 28, 0.2);
            background: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-ink);
        }
        .filter-pill input {
            accent-color: var(--color-primary);
        }
        .calendar-links {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px dashed rgba(42, 36, 28, 0.2);
            border-radius: 12px;
            padding: 0.75rem;
        }
        .calendar-links a {
            display: block;
            font-size: 0.8rem;
            color: #1e4b7a;
            font-weight: 600;
            margin-top: 0.35rem;
        }
        @media (max-width: 640px) {
            .day-cell {
                min-height: 80px;
            }
            .calendar-event {
                font-size: 0.62rem;
            }
        }
        
        /* NEW Styles for Collapsible Sections */
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out;
            max-height: 2000px; /* Set to a large value */
            opacity: 1;
        }
        .collapsible-content.is-collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        .chevron-icon.rotate-180 {
            transform: rotate(180deg);
        }
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white;
                font-family: var(--font-body);
                margin: 0;
                padding: 0;
            }
            body::before,
            .guide-card::after {
                display: none;
            }
            .guide-card {
                box-shadow: none;
                border: none;
                max-width: 100%;
                padding: 0;
            }
            #guide-footer, .no-print {
                display: none;
            }
            header > :not(#reporting-tool) {
                display: none !important;
            }
            #reporting-tool {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            #reporting-tool.hidden {
                display: block !important;
            }
            .report-section {
                margin-top: 2rem;
                padding: 1rem;
                border: 1px solid #ccc;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .collapsible-content {
                max-height: none !important;
                opacity: 1 !important;
                display: block !important;
            }
            .collapsible-content.is-collapsed {
                max-height: none !important;
                opacity: 1 !important;
                display: block !important;
            }
            .chevron-icon {
                display: none;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2;
            }
        }
    </style>
</head>
<body class="p-4 flex items-start justify-center min-h-screen pt-8">

    <!-- Main Guide Card -->
    <div id="guide-card" class="guide-card max-w-3xl w-full p-6 md:p-8">

        <!-- Title and Progress -->
        <header class="mb-6 header-stack">
            <h1 class="text-3xl md:text-5xl font-extrabold text-gray-800 text-center mb-1">
                Sweet Potato Farming and Tracking Guide üç†
            </h1>
            <p class="text-center text-gray-500 font-medium mb-4">
                Smart Steps for Growing, Tracking, and Selling (11 Phases)
            </p>
            
            <!-- Planner and Log Toggle Tabs -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-4">
                <button id="toggle-guide-btn" class="tab-btn" data-view="guide" data-accent="primary" aria-pressed="false">
                    Step-by-Step Guide
                </button>
                <button id="toggle-planner-btn" class="tab-btn" data-view="planner" data-accent="sun" aria-pressed="false">
                    Crop Planner üóìÔ∏è
                </button>
                <button id="toggle-log-btn" class="tab-btn" data-view="log" data-accent="leaf" aria-pressed="false">
                    My Project Log ‚úÖ
                </button>
                <button id="toggle-reporting-btn" class="tab-btn sm:col-span-3" data-view="reporting" data-accent="river" aria-pressed="false">
                    Reporting & Analysis üìä
                </button>
            </div>
            
            <!-- Planner Tool Area (Starts Hidden) -->
            <div id="planner-tool" class="tool-panel hidden mt-4 p-4 rounded-lg">
                <h3 class="text-xl font-bold mb-2 text-gray-700">Crop Planting Scheduler <button onclick="setView('guide')" class="link-btn ml-3">Go to Guide</button></h3>
                <p class="text-sm mb-3 text-gray-600">
                    Choose when you want to plant your slips to calculate key dates based on your local assumptions below.
                    <span class="font-bold text-red-600">You must set your planting date below to see the schedule!</span>
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                    <label for="planting-date" class="font-semibold text-gray-700 w-full sm:w-auto">My Planting Date (Step 5):</label>
                    <input type="date" id="planting-date" class="p-2 border rounded-md shadow-inner flex-1 w-full" onchange="calculateAndRenderSchedule()">
                </div>
                
                <h4 class="font-bold text-gray-700 mb-2">Schedule Assumptions (Adjust for your Geography):</h4>
                <div id="assumption-inputs" class="text-sm bg-white p-4 rounded-md border grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    
                    <label class="block">
                        <span class="text-gray-700 font-medium">Days from Planting to Harvest</span>
                        <input type="number" id="daysToHarvest" value="120" min="90" max="180" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Key variable based on variety and climate.</p>
                    </label>

                    <label class="block">
                        <span class="text-gray-700 font-medium">Days for Slip Rooting (in water)</span>
                        <input type="number" id="daysPropagation" value="14" min="7" max="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Time needed to grow 1-inch roots on slips (Step 3).</p>
                    </label>

                    <label class="block">
                        <span class="text-gray-700 font-medium">Days for Mother Sprouting</span>
                        <input type="number" id="daysMotherStart" value="35" min="20" max="60" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Time needed for mother potato to produce slips (Step 1-2).</p>
                    </label>
                    
                    <label class="block">
                        <span class="text-gray-700 font-medium">Days for Field Preparation</span>
                        <input type="number" id="daysPrePlantingPrep" value="7" min="1" max="14" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Time needed for soil testing and mounding (Step 4).</p>
                    </label>
                </div>

                <div id="calendar-output" class="mt-4 space-y-3 p-3 bg-white rounded-lg border">
                    <p class="text-gray-500 italic" id="planner-placeholder">
                        Enter a planting date above to see your full schedule.
                    </p>
                    <!-- Calendar links will be inserted here -->
                </div>

                <div id="planner-actions" class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3 hidden no-print">
                    <button id="add-all-btn" class="btn-primary w-full px-6 py-2 rounded-lg font-bold text-sm">
                        Add All Events to Google Calendar
                    </button>
                    <button id="download-ics-btn" class="btn-secondary w-full px-6 py-2 rounded-lg font-bold text-sm">
                        Download iCal (.ics) for Apple/Google
                    </button>
                    <button id="print-calendar-btn" class="btn-tertiary w-full px-6 py-2 rounded-lg font-bold text-sm">
                        Print / Download Calendar
                    </button>
                </div>

                <div id="planner-calendar-wrap" class="mt-6 hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                        <h4 class="text-xl font-bold text-gray-700">Calendar View</h4>
                        <div class="calendar-legend">
                            <span class="legend-chip legend-planned">Planned</span>
                            <span class="legend-chip legend-completed">Completed</span>
                            <span class="legend-chip"><span class="legend-dot event-orange"></span>Sprouting/Curing</span>
                            <span class="legend-chip"><span class="legend-dot event-blue"></span>Rooting/Water</span>
                            <span class="legend-chip"><span class="legend-dot event-green"></span>Planting/Growth</span>
                            <span class="legend-chip"><span class="legend-dot event-brown"></span>Harvesting</span>
                            <span class="legend-chip"><span class="legend-dot event-gray"></span>Storage/Sales</span>
                        </div>
                    </div>
                    <div id="planner-filters" class="planner-filters mb-4">
                        <div class="filter-group">
                            <span class="filter-title">Show</span>
                            <label class="filter-pill">
                                <input type="radio" name="status-filter" value="all" checked>
                                Both
                            </label>
                            <label class="filter-pill">
                                <input type="radio" name="status-filter" value="planned">
                                Planned
                            </label>
                            <label class="filter-pill">
                                <input type="radio" name="status-filter" value="completed">
                                Completed
                            </label>
                        </div>
                        <div class="filter-group">
                            <span class="filter-title">Phase Filters</span>
                            <label class="filter-pill">
                                <input type="checkbox" value="sprouting" checked>
                                Sprouting
                            </label>
                            <label class="filter-pill">
                                <input type="checkbox" value="curing" checked>
                                Curing
                            </label>
                            <label class="filter-pill">
                                <input type="checkbox" value="slip_rooting" checked>
                                Slip Rooting
                            </label>
                            <label class="filter-pill">
                                <input type="checkbox" value="slip_planting" checked>
                                Slip Planting
                            </label>
                            <label class="filter-pill">
                                <input type="checkbox" value="harvesting" checked>
                                Harvesting
                            </label>
                            <label class="filter-pill">
                                <input type="checkbox" value="storage" checked>
                                Storage
                            </label>
                            <label class="filter-pill">
                                <input type="checkbox" value="sales" checked>
                                Sales
                            </label>
                        </div>
                    </div>
                    <div id="planner-calendar" class="calendar-grid"></div>
                    <div id="calendar-links-output" class="calendar-links hidden"></div>
                </div>
            </div>

            <!-- Project Log Area (Starts Hidden) -->
            <div id="project-log-tool" class="tool-panel hidden mt-4 p-4 rounded-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-700">My Project Activity Log <button onclick="setView('guide')" class="link-btn ml-3">Go to Guide</button></h3>
                
                <p class="text-sm text-gray-600 mb-4">Use this log to mark steps complete, record the date you did them, and add multiple data entries for key metrics. Click a step title to expand or collapse it.</p>

                <div id="log-entries" class="space-y-4">
                    <!-- Log fields for each step will be inserted here -->
                </div>
            </div>

            <!-- Reporting Tool Area (Starts Hidden) -->
            <div id="reporting-tool" class="tool-panel hidden mt-4 p-4 rounded-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Reporting & Analysis <button onclick="setView('guide')" class="link-btn ml-3">Go to Guide</button></h3>
                <div class="flex gap-4 mb-4 no-print">
                    <button onclick="renderReport(true)" class="flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm">
                        Refresh Report
                    </button>
                    <button onclick="printReport()" class="flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm">
                        Print Report
                    </button>
                    <button id="download-json-btn" class="flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm">
                        Download Data (JSON)
                    </button>
                </div>
                <div id="report-output" class="p-4 bg-white rounded-lg border">
                    <p class="text-gray-500 italic">Click "Refresh Report" to see your project data.</p>
                </div>
            </div>


            <!-- Progress Bar (Only visible with Guide) -->
            <div id="progress-container" class="mt-6">
                <p id="progress-text" class="text-sm text-center text-gray-600 font-medium mb-1"></p>
                <div class="progress-track h-3 rounded-full overflow-hidden">
                    <div id="progress-bar" class="progress-fill h-3 transition-all duration-500" style="width: 0%;"></div>
                </div>
            </div>

        </header>

        <!-- Step Content Area (Only visible with Guide) -->
        <div id="content-area" class="step-content">
            <div id="step-icon" class="text-6xl text-center mb-4 font-extrabold text-gray-800"></div>
            <h2 id="step-title" class="text-2xl font-bold text-gray-700 mb-3 text-center"></h2>
            <p id="step-description" class="text-gray-600 text-lg leading-relaxed"></p>
            <div id="step-actions" class="mt-4 text-center"></div>
        </div>

        <!-- Navigation Buttons (Only visible with Guide) -->
        <footer id="guide-footer" class="mt-8 flex justify-between gap-4">
            <button id="prev-btn" class="btn-secondary px-6 py-3 rounded-xl font-bold w-1/2 md:w-auto flex-1" disabled>
                &larr; Previous
            </button>
            <button id="next-btn" class="btn-primary px-6 py-3 rounded-xl font-bold w-1/2 md:w-auto flex-1">
                Next Step &rarr;
            </button>
        </footer>

    </div>

    <script>
        // --- DATA & ASSUMPTIONS ---

        // Guide Steps (Cleaned up: All LaTeX artifacts removed from descriptions)
        const steps = [
            { id: 'start_mother', title: '1. Start the Mother Potato', 
                description: "Choose a healthy sweet potato. Stick 3 or 4 small sticks (like toothpicks) into the middle. Put the bottom half of the potato in a jar of water and put it in a sunny spot. This is the **Sprouting Phase**.", 
                visual: "ü•î ‚Üí üìå ‚Üí üíß‚òÄÔ∏è"
            },
            { id: 'cut_slips', title: '2. Master Slip Cutting', 
                description: "Propagate Many Plants! When a slip is about 4 fingers long (4-6 inches), cut or twist it off the mother potato above the water line. Use the <span class=\"font-bold\">Project Log</span> to track how many slips you cut.", 
                visual: "üç†üåø ‚Üí ‚úÇÔ∏è ‚Üí üåø" 
            },
            { id: 'root_slips', title: '3. Make the Slips Grow Roots', 
                description: "Put the cut slips into a new jar of clean water, leaf-side up. Change the water every 2 days. Wait until the roots are about 1 inch long. This is the **Rooting Phase**.", 
                visual: "üåø ‚Üí üíß ‚Üí üå±"
            },
            { id: 'soil_prep', title: '4. Smart Step: Soil Test & Field Prep', 
                description: "Before planting, take a soil sample and test the pH (ideally 5.8-6.2). Prepare **raised dirt mounds** about 1-2 steps apart to ensure good drainage. Log your pH reading in the <span class=\"font-bold\">Project Log</span>.", 
                visual: "üçö ‚Üí pH ‚Üí ‚õ∞Ô∏è"
            },
            { id: 'plant_field', title: '5. Plant in the Soil (Day 0)', 
                description: "Plant the rooted slips into the mounds, burying the roots and most of the stem. Sweet potatoes need full sun, all day. This begins the **Growing Phase**.", 
                visual: "üå± ‚Üí ‚õ∞Ô∏è ‚Üí üí¶"
            },
            { id: 'scouting', title: '6. Smart Step: Pest and Disease Scouting', 
                description: "During the first 60 days of growth, actively scout your field. Check the underside of leaves for insects or signs of disease. Early detection is key! Log any sightings in the <span class=\"font-bold\">Project Log</span>.", 
                visual: "üîé ‚Üí üåø ‚Üí üêû"
            },
            { id: 'manage_vines', title: '7. Care for the Vines (Pruning)', 
                description: "Water regularly, but let the soil dry out slightly between waterings. If the vines start growing extra roots down into the soil, **cut these extra roots** to force the plant to focus energy on the main tubers.", 
                visual: "üåø ‚Üí ‚úÇÔ∏è ‚Üí üç† (BIG)"
            },
            { id: 'harvest', title: '8. Know When to Harvest', 
                description: "Tubers are ready 90 to 180 days after planting, signaled when vines turn yellow and die back. Dig carefully and remember to log your **Total Harvest (Kg)** in the <span class=\"font-bold\">Project Log</span>!", 
                visual: "üçÇ ‚Üí ‚õèÔ∏è ‚Üí üß∫"
            },
            { id: 'cure', title: '9. Curing for Sweetness', 
                description: "Gently brush off dirt (do NOT wash). Cure them in a warm, dry, dark room (around 75-85¬∞F) for 10 days. This heals cuts and turns starch to sugar.", 
                visual: "üç† ‚Üí üî•üîí ‚Üí üç¨"
            },
            { id: 'storage', title: '10. Storage for Later', 
                description: "Move cured potatoes to a cool, dry place (55-60¬∞F), dark and well-ventilated. Properly stored sweet potatoes can last up to a year!", 
                visual: "üç¨ ‚Üí üì¶ ‚Üí ‚ùÑÔ∏è"
            },
            { id: 'sale', title: '11. Selling Your Crop', 
                description: "Sort potatoes by size and quality. Use health facts (Vitamin A!) to market your crop effectively.", 
                visual: "üç† ‚Üí üè∑Ô∏è ‚Üí ü§ù"
            }
        ];

        // Base Schedule Definitions (used for log fields and relative step ordering)
        // UPDATED with new logFields structure
        const baseSchedule = [
            { id: 'start_mother', step: 1, activity: 'Start Mother Tuber', color: 'orange', durationKey: 'daysMotherStart', icon: 'üíß', phase: 'Sprouting', 
                logFields: [
                    { label: 'Date Started', type: 'date' },
                    { label: 'Tuber ID/Name', type: 'text', placeholder: 'e.g., Mother A' },
                    { label: 'Generation', type: 'text', placeholder: 'e.g., G0, G1' },
                    { label: 'Source', type: 'text', placeholder: 'e.g., Store, Saved' }
                ], 
                details: 'Place mother potato in water to begin slip production.' 
            },
            { id: 'cut_slips', step: 2, activity: 'Cut Slips', color: 'blue', icon: '‚úÇÔ∏è', phase: 'Sprouting',
                logFields: [
                    { label: 'Date Cut', type: 'date' },
                    { label: 'From Tuber ID', type: 'text', placeholder: 'e.g., Mother A' },
                    { label: 'Slips Cut', type: 'number', placeholder: 'e.g., 15' }
                ],
                details: 'Cut slips from mother tubers.'
            },
            { id: 'root_slips', step: 3, activity: 'Start Rooting Slips', color: 'blue', durationKey: 'daysPropagation', icon: '‚úÇÔ∏è', phase: 'Rooting', 
                logFields: [
                    { label: 'Date Rooting Started', type: 'date' },
                    { label: 'Slips Put in Water', type: 'number', placeholder: 'e.g., 15' }
                ], 
                details: 'Cut slips and place them in water to grow roots.' 
            },
            { id: 'soil_prep', step: 4, activity: 'Soil Test & Field Prep', color: 'gray', durationKey: 'daysPrePlantingPrep', icon: '‚õ∞Ô∏è', phase: 'Field Prep', 
                logFields: [
                    { label: 'Date Tested', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Soil pH', type: 'number', placeholder: 'e.g., 6.1' }
                ], 
                details: 'Test soil pH and prepare mounds for planting.' 
            },
            { id: 'plant_field', step: 5, activity: 'Plant Slips in Field (Day 0)', color: 'green', durationKey: 'daysToHarvest', icon: 'üå±', phase: 'Growing', 
                logFields: [
                    { label: 'Date Planted', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Slips Planted', type: 'number', placeholder: 'e.g., 50' }
                ], 
                details: 'Plant rooted slips in warm, mounded soil.' 
            },
            { id: 'scouting_start', step: 6, activity: 'Pest/Disease Scouting', color: 'blue', fixedStartDays: 30, durationDays: 60, icon: 'üîé', phase: 'Monitoring', 
                logFields: [
                    { label: 'Date Sighted', type: 'date' },
                    { label: 'Pest/Disease Name', type: 'text', placeholder: 'e.g., Aphids' },
                    { label: 'GPS (Lat, Lon)', type: 'text', placeholder: 'e.g., 40.71, -74.00' },
                    { label: 'Notes/Action Taken', type: 'textarea', placeholder: 'Spotted on 3 plants...' }
                ], 
                details: 'Active monitoring period for pests and disease (Days 30-90).' 
            },
            { id: 'manage_vines', step: 7, activity: 'Vine Management (Pruning)', color: 'green', icon: '‚úÇÔ∏è', phase: 'Monitoring',
                logFields: [
                    { label: 'Date Pruned', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Notes', type: 'textarea', placeholder: 'e.g., Pruned runners...' }
                ],
                details: 'Log dates of vine pruning or maintenance.'
            },
            { id: 'harvest', step: 8, activity: 'Harvest Tubers', color: 'brown', offsetKey: 'daysToHarvest', durationDays: 0, icon: 'üß∫', phase: 'Harvesting', 
                logFields: [
                    { label: 'Harvest Date', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Total Harvest (Kg)', type: 'number', placeholder: 'e.g., 12.5' }
                ], 
                details: 'Dig tubers when vines die back. Log your harvest metrics.' 
            }, 
            { id: 'cure', step: 9, activity: 'Start Curing', color: 'orange', offsetKey: 'daysToHarvest', durationDays: 10, icon: 'üî•', phase: 'Curing', 
                logFields: [
                    { label: 'Curing Start Date', type: 'date' },
                    { label: 'Location', type: 'text', placeholder: 'e.g., Curing Shed' },
                    { label: 'Avg. Temp (¬∞F)', type: 'number', placeholder: 'e.g., 80' }
                ], 
                details: 'Cure potatoes for 10 days in a warm, dark place to sweeten and heal skin.' 
            },
            { id: 'storage', step: 10, activity: 'Begin Storage/Sale', color: 'gray', offsetKey: 'daysToHarvest', durationDays: 10, fixedEndOffset: 10, icon: 'üì¶', phase: 'Storage', 
                logFields: [
                    { label: 'Storage Start Date', type: 'date' },
                    { label: 'Location', type: 'text', placeholder: 'e.g., Root Cellar' }
                ], 
                details: 'Move cured potatoes to cool, dry storage (55-60¬∞F).' 
            },
            { id: 'sale', step: 11, activity: 'Log Sale', color: 'green', icon: 'ü§ù', phase: 'Sales',
                logFields: [
                    { label: 'Sale Date', type: 'date' },
                    { label: 'Quantity Sold (Kg)', type: 'number', placeholder: 'e.g., 25' },
                    { label: 'Price per Kg ($)', type: 'number', placeholder: 'e.g., 1.50' },
                    { label: 'Customer/Market', type: 'text', placeholder: 'e.g., Farmer\'s Market' }
                ],
                details: 'Log sales data to track revenue.'
            }
        ];


        // --- DOM ELEMENT REFERENCES ---
        const contentArea = document.getElementById('content-area');
        const stepIcon = document.getElementById('step-icon');
        const stepTitle = document.getElementById('step-title');
        const stepDescription = document.getElementById('step-description');
        const stepActions = document.getElementById('step-actions');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const plannerTool = document.getElementById('planner-tool');
        const projectLogTool = document.getElementById('project-log-tool');
        const reportingTool = document.getElementById('reporting-tool');
        const reportOutput = document.getElementById('report-output');
        const progressContainer = document.getElementById('progress-container');
        const guideFooter = document.getElementById('guide-footer');

        const toggleGuideBtn = document.getElementById('toggle-guide-btn');
        const togglePlannerBtn = document.getElementById('toggle-planner-btn');
        const toggleLogBtn = document.getElementById('toggle-log-btn');
        const toggleReportingBtn = document.getElementById('toggle-reporting-btn');
        const viewButtons = {
            guide: toggleGuideBtn,
            planner: togglePlannerBtn,
            log: toggleLogBtn,
            reporting: toggleReportingBtn,
        };
        const viewButtonList = Object.values(viewButtons);

        const plantingDateInput = document.getElementById('planting-date');
        const calendarOutput = document.getElementById('calendar-output');
        const assumptionInputs = document.getElementById('assumption-inputs');
        const addAllBtn = document.getElementById('add-all-btn');
        const plannerActions = document.getElementById('planner-actions');
        const plannerCalendarWrap = document.getElementById('planner-calendar-wrap');
        const plannerCalendar = document.getElementById('planner-calendar');
        const downloadIcsBtn = document.getElementById('download-ics-btn');
        const printCalendarBtn = document.getElementById('print-calendar-btn');
        const plannerFiltersContainer = document.getElementById('planner-filters');
        const calendarLinksOutput = document.getElementById('calendar-links-output');
        
        const logEntriesContainer = document.getElementById('log-entries');


        // --- STATE & UTILITIES ---
        let currentStep = 0;
        let activeView = 'guide'; // 'guide', 'planner', 'log', 'reporting'
        let plannerPlantingDate = null;
        let plannerPlannedEvents = [];
        let plannerCompletedEvents = [];

        const plannerFilters = {
            status: 'all',
            phases: {
                sprouting: true,
                curing: true,
                slip_rooting: true,
                slip_planting: true,
                harvesting: true,
                storage: true,
                sales: true,
            },
        };
        
        // NEW Data Structure: Log now holds multiple entries per step
        // projectLog = { 
        //   'step_id': { done: false, date: '', entries: [ { 'Field Label': 'value', ... }, ... ] } 
        // }
        let projectLog = {}; 
        
        const COLORS = {
            'orange': 'border-orange-500 bg-orange-100',
            'blue': 'border-blue-500 bg-blue-100',
            'green': 'border-green-500 bg-green-100',
            'brown': 'border-amber-700 bg-amber-100',
            'red': 'border-red-500 bg-red-100',
            'gray': 'border-gray-500 bg-gray-100',
        };
        const EVENT_CLASS_MAP = {
            orange: 'event-orange',
            blue: 'event-blue',
            green: 'event-green',
            brown: 'event-brown',
            gray: 'event-gray',
            red: 'event-orange',
        };

        function setActiveTab(viewName) {
            viewButtonList.forEach((btn) => {
                btn.classList.remove('is-active');
                btn.setAttribute('aria-pressed', 'false');
            });
            const activeBtn = viewButtons[viewName];
            if (activeBtn) {
                activeBtn.classList.add('is-active');
                activeBtn.setAttribute('aria-pressed', 'true');
            }
        }

        // Helper: Format date as YYYYMMDD for Google Calendar
        function formatDateForGoogle(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        function formatDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            if (!year || !month || !day) return null;
            return new Date(year, month - 1, day);
        }

        function addDays(date, days) {
            const next = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            next.setDate(next.getDate() + days);
            return next;
        }

        function formatDateForIcs(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        function escapeIcsText(value) {
            return String(value || '')
                .replace(/\\\\/g, '\\\\\\\\')
                .replace(/;/g, '\\\\;')
                .replace(/,/g, '\\\\,')
                .replace(/\\r?\\n/g, '\\\\n');
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function stripHtmlTags(value) {
            return String(value ?? '').replace(/<[^>]*>/g, '');
        }

        function truncateText(value, maxLength) {
            const text = String(value ?? '');
            if (text.length <= maxLength) return text;
            return `${text.slice(0, maxLength - 3).trim()}...`;
        }

        function mapPhaseToCategory(phase) {
            const normalized = String(phase || '').toLowerCase();
            if (normalized.includes('sprouting')) return 'sprouting';
            if (normalized.includes('rooting')) return 'slip_rooting';
            if (normalized.includes('curing')) return 'curing';
            if (normalized.includes('harvest')) return 'harvesting';
            if (normalized.includes('storage')) return 'storage';
            if (normalized.includes('sales')) return 'sales';
            if (normalized.includes('growing')) return 'slip_planting';
            if (normalized.includes('field prep')) return 'slip_planting';
            if (normalized.includes('monitoring')) return 'slip_planting';
            return 'slip_planting';
        }

        // Helper: Get Google Calendar URL for a single event
        function getGoogleCalendarUrl(startDate, activity, details, durationDays = 1, stepNumber) {
            const startStr = formatDateForGoogle(startDate);
            const endDate = new Date(startDate);
            // Google Calendar requires a date range (start day / end day)
            endDate.setDate(startDate.getDate() + durationDays);
            const endStr = formatDateForGoogle(endDate);
            
            const title = `Sweet Potato: ${activity}`;

            const baseUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
            const text = encodeURIComponent(title);
            const dates = `${startStr}/${endStr}`;
            const detailsText = encodeURIComponent(details + ` (Reference Guide Step ${stepNumber})`);

            return `${baseUrl}&text=${text}&dates=${dates}&details=${detailsText}`;
        }

        // Helper: Get Google Calendar URL for ALL events (iCal/Web Cal)
        function getBulkCalendarUrl(events) {
            const baseUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
            let bulkTitle = "Sweet Potato Full Project Plan";
            let bulkDetails = "Your full scheduled plan, calculated based on your Planting Date:\n";

            events.forEach((event, index) => {
                // Ensure eventDate is a date object
                const readableDate = new Date(event.startDate).toDateString();

                bulkDetails += `\n${index + 1}. ${event.title}: ${readableDate}. Duration: ${event.durationDays ? event.durationDays + ' days' : '1 day'}.`;
            });

            // For simplicity, we create a single "Project Start" event with all dates in the details
            const today = new Date();
            const startStr = formatDateForGoogle(today);
            const endStr = formatDateForGoogle(today);
            
            const text = encodeURIComponent(bulkTitle);
            const dates = `${startStr}/${endStr}`;
            const detailsText = encodeURIComponent(bulkDetails);

            return `${baseUrl}&text=${text}&dates=${dates}&details=${detailsText}`;
        }

        // Helper to safely get value from assumption inputs
        const getAssumptionValue = (id) => {
            return parseFloat(document.getElementById(id)?.value) || 0;
        };

        function syncCollapsibleHeights(root = document) {
            root.querySelectorAll('.collapsible-content').forEach((section) => {
                if (section.classList.contains('is-collapsed')) {
                    section.style.maxHeight = '0px';
                } else {
                    section.style.maxHeight = `${section.scrollHeight}px`;
                }
            });
        }

        function shouldIncludeInPlanner(event) {
            if (event.durationKey === undefined && event.durationDays === undefined && event.fixedStartDays === undefined) {
                if (event.id === 'cut_slips') return false;
                if (!event.logFields || event.logFields.length === 0) return false;
            }
            return true;
        }

        function buildPlannedEvents(dynamicSchedule, plantingDate) {
            const plannedEvents = [];
            dynamicSchedule.forEach((event) => {
                if (!shouldIncludeInPlanner(event)) return;
                const stepMeta = steps[event.step - 1];
                const stepId = stepMeta ? stepMeta.id : event.id;
                const startDate = addDays(plantingDate, event.offsetDays);
                const duration = event.durationDays > 0 ? event.durationDays : 1;
                plannedEvents.push({
                    id: event.id,
                    stepId,
                    title: event.activity,
                    startDate,
                    durationDays: duration,
                    icon: event.icon || '',
                    color: event.color || 'gray',
                    phase: event.phase,
                    category: mapPhaseToCategory(event.phase),
                    details: event.details,
                    instruction: stepMeta ? stepMeta.description : event.details,
                    step: event.step,
                    type: 'planned',
                });
            });
            return plannedEvents;
        }

        function buildCompletedEvents() {
            const completedEvents = [];
            baseSchedule.forEach((scheduleItem) => {
                const stepMeta = steps[scheduleItem.step - 1];
                const stepId = stepMeta ? stepMeta.id : scheduleItem.id;
                const stepLog = projectLog[stepId];
                if (!stepLog) return;

                if (stepLog.date) {
                    const completionDate = parseLocalDate(stepLog.date);
                    if (completionDate) {
                        completedEvents.push({
                            id: stepId,
                            stepId,
                            title: `${scheduleItem.activity} - Step Complete`,
                            date: completionDate,
                            color: scheduleItem.color || 'gray',
                            category: mapPhaseToCategory(scheduleItem.phase),
                            type: 'completed',
                            details: scheduleItem.details,
                            instruction: stepMeta ? stepMeta.description : scheduleItem.details,
                        });
                    }
                }

                if (!scheduleItem.logFields || scheduleItem.logFields.length === 0) return;
                const dateFields = scheduleItem.logFields.filter((field) => field.type === 'date');
                if (dateFields.length === 0) return;

                (stepLog.entries || []).forEach((entry) => {
                    dateFields.forEach((field) => {
                        const dateValue = entry[field.label];
                        const entryDate = parseLocalDate(dateValue);
                        if (!entryDate) return;

                        completedEvents.push({
                            id: stepId,
                            stepId,
                            title: `${scheduleItem.activity} - ${field.label}`,
                            date: entryDate,
                            color: scheduleItem.color || 'gray',
                            category: mapPhaseToCategory(scheduleItem.phase),
                            type: 'completed',
                            details: scheduleItem.details,
                            instruction: stepMeta ? stepMeta.description : scheduleItem.details,
                        });
                    });
                });
            });
            return completedEvents;
        }

        function filterPlannerEvents(plannedEvents, completedEvents) {
            const phaseFilter = plannerFilters.phases;
            const matchesPhase = (event) => phaseFilter[event.category] !== false;
            let filteredPlanned = plannedEvents.filter(matchesPhase);
            let filteredCompleted = completedEvents.filter(matchesPhase);

            if (plannerFilters.status === 'planned') {
                filteredCompleted = [];
            } else if (plannerFilters.status === 'completed') {
                filteredPlanned = [];
            }

            return { planned: filteredPlanned, completed: filteredCompleted };
        }

        function buildEventsByDay(plannedEvents, completedEvents) {
            const eventsByDay = new Map();
            const pushEvent = (event) => {
                const key = formatDateKey(event.date);
                if (!eventsByDay.has(key)) {
                    eventsByDay.set(key, []);
                }
                eventsByDay.get(key).push(event);
            };

            plannedEvents.forEach((event) => {
                const duration = event.durationDays || 1;
                for (let dayIndex = 0; dayIndex < duration; dayIndex += 1) {
                    pushEvent({
                        ...event,
                        date: addDays(event.startDate, dayIndex),
                        dayIndex,
                        totalDays: duration,
                    });
                }
            });

            completedEvents.forEach((event) => {
                pushEvent({
                    ...event,
                    date: event.date,
                    totalDays: 1,
                    dayIndex: 0,
                });
            });

            return eventsByDay;
        }

        function getCalendarRange(plannedEvents, completedEvents, plantingDate) {
            let minDate = null;
            let maxDate = null;
            const considerDate = (date) => {
                if (!minDate || date < minDate) minDate = date;
                if (!maxDate || date > maxDate) maxDate = date;
            };

            plannedEvents.forEach((event) => {
                considerDate(event.startDate);
                considerDate(addDays(event.startDate, (event.durationDays || 1) - 1));
            });
            completedEvents.forEach((event) => {
                considerDate(event.date);
            });

            if (!minDate && plantingDate) {
                minDate = new Date(plantingDate.getFullYear(), plantingDate.getMonth(), 1);
                maxDate = addDays(minDate, 30);
            }

            return { minDate, maxDate };
        }

        function renderPlannerCalendar(plantingDate, plannedEvents, completedEvents) {
            if (!plannerCalendar || !plannerCalendarWrap) return;
            const filteredEvents = filterPlannerEvents(plannedEvents, completedEvents);
            plannerCalendarWrap.classList.remove('hidden');
            if (!filteredEvents.planned.length && !filteredEvents.completed.length) {
                plannerCalendar.innerHTML = '<p class="text-sm text-gray-500 italic">No events match the selected filters.</p>';
                return;
            }
            const eventsByDay = buildEventsByDay(filteredEvents.planned, filteredEvents.completed);
            const { minDate, maxDate } = getCalendarRange(filteredEvents.planned, filteredEvents.completed, plantingDate);
            if (!minDate || !maxDate) {
                plannerCalendar.innerHTML = '';
                return;
            }

            const startMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            const endMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
            const todayKey = formatDateKey(new Date());
            const plantingKey = plantingDate ? formatDateKey(plantingDate) : null;
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const typeOrder = { completed: 0, planned: 1 };

            let html = '';
            for (let cursor = new Date(startMonth); cursor <= endMonth; cursor.setMonth(cursor.getMonth() + 1)) {
                const monthYear = cursor.toLocaleString('default', { month: 'long', year: 'numeric' });
                const firstDay = new Date(cursor.getFullYear(), cursor.getMonth(), 1);
                const startOffset = firstDay.getDay();
                const daysInMonth = new Date(cursor.getFullYear(), cursor.getMonth() + 1, 0).getDate();

                let daysHtml = '<div class="calendar-days">';
                dayNames.forEach((dayName) => {
                    daysHtml += `<div class="day-name">${dayName}</div>`;
                });
                daysHtml += '</div><div class="calendar-days">';

                for (let i = 0; i < startOffset; i += 1) {
                    daysHtml += '<div class="day-cell is-empty"></div>';
                }

                for (let day = 1; day <= daysInMonth; day += 1) {
                    const date = new Date(cursor.getFullYear(), cursor.getMonth(), day);
                    const dateKey = formatDateKey(date);
                    const cellClasses = ['day-cell'];
                    if (dateKey === todayKey) cellClasses.push('is-today');
                    if (plantingKey && dateKey === plantingKey) cellClasses.push('is-planting');

                    const events = (eventsByDay.get(dateKey) || []).slice().sort((a, b) => {
                        return typeOrder[a.type] - typeOrder[b.type] || a.title.localeCompare(b.title);
                    });

                    const maxEventsToShow = 3;
                    const visibleEvents = events.slice(0, maxEventsToShow);
                    const extraCount = events.length - maxEventsToShow;
                    let eventsHtml = '';

                    visibleEvents.forEach((event) => {
                        const statusLabel = event.type === 'completed' ? 'Completed' : 'Planned';
                        const dayLabel = event.type === 'planned' && event.totalDays > 1
                            ? `${event.title} (${event.dayIndex + 1}/${event.totalDays})`
                            : event.title;
                        const fullLabel = `${statusLabel}: ${dayLabel}`;
                        const instructionText = stripHtmlTags(event.instruction || '');
                        const detailsText = stripHtmlTags(event.details || '');
                        const combinedText = `${instructionText}${detailsText ? ` Details: ${detailsText}` : ''}`.trim();
                        const tooltipText = truncateText(combinedText || 'Click to open instructions', 200);
                        const tooltipHtml = `
                            <span class="event-tooltip">
                                ${escapeHtml(tooltipText)}
                                <br>
                                <span class="text-xs opacity-80">Click to open instructions</span>
                            </span>
                        `;
                        const eventClass = EVENT_CLASS_MAP[event.color] || 'event-gray';
                        eventsHtml += `
                            <button type="button" class="calendar-event ${event.type} ${eventClass}" data-step="${escapeHtml(event.stepId || '')}" aria-label="${escapeHtml(fullLabel)}">
                                ${escapeHtml(fullLabel)}
                                ${tooltipHtml}
                            </button>
                        `;
                    });

                    if (extraCount > 0) {
                        eventsHtml += `<span class="calendar-more">+${extraCount} more</span>`;
                    }

                    daysHtml += `
                        <div class="${cellClasses.join(' ')}">
                            <span class="day-number">${day}</span>
                            <div class="event-stack">${eventsHtml}</div>
                        </div>
                    `;
                }

                daysHtml += '</div>';
                html += `
                    <div class="calendar-month">
                        <div class="calendar-month-header">
                            <h5 class="text-lg font-bold text-gray-700">${monthYear}</h5>
                        </div>
                        ${daysHtml}
                    </div>
                `;
            }

            plannerCalendar.innerHTML = html;
        }

        function buildIcsFile(events) {
            const nowStamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const lines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Sweet Potato Farm//Planner//EN',
                'CALSCALE:GREGORIAN',
            ];

            events.forEach((event) => {
                const startDate = event.startDate || event.date;
                const duration = event.durationDays || 1;
                const endDate = addDays(startDate, duration);
                const startStr = formatDateForIcs(startDate);
                const endStr = formatDateForIcs(endDate);
                const uid = `${startStr}-${event.type}-${event.id || 'log'}-${Math.random().toString(36).slice(2, 9)}@sweetpotato`;
                const summaryPrefix = event.type === 'completed' ? 'Completed' : 'Planned';
                const summary = `${summaryPrefix}: ${event.title}`;
                const details = event.details ? `${event.details}` : '';

                lines.push(
                    'BEGIN:VEVENT',
                    `UID:${escapeIcsText(uid)}`,
                    `DTSTAMP:${nowStamp}`,
                    `SUMMARY:${escapeIcsText(summary)}`,
                    `DESCRIPTION:${escapeIcsText(details)}`,
                    `DTSTART;VALUE=DATE:${startStr}`,
                    `DTEND;VALUE=DATE:${endStr}`,
                    'END:VEVENT'
                );
            });

            lines.push('END:VCALENDAR');
            return lines.join('\r\n');
        }

        function downloadCalendarIcs(events) {
            if (!events.length) return;
            const sortedEvents = events.slice().sort((a, b) => {
                const aDate = a.startDate || a.date;
                const bDate = b.startDate || b.date;
                return aDate - bDate;
            });
            const icsContent = buildIcsFile(sortedEvents);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sweet_potato_planner.ics';
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }

        function refreshPlannerCalendar() {
            if (!plannerPlantingDate) return;
            plannerCompletedEvents = buildCompletedEvents();
            renderPlannerCalendar(plannerPlantingDate, plannerPlannedEvents, plannerCompletedEvents);
        }

        function renderCalendarLinks(events) {
            if (!calendarLinksOutput) return;
            if (!events.length) {
                calendarLinksOutput.classList.add('hidden');
                calendarLinksOutput.innerHTML = '';
                return;
            }

            let html = '<p class="text-sm text-gray-600 font-medium">Pop-ups blocked? Use these links:</p>';
            events.forEach((event) => {
                const url = getGoogleCalendarUrl(event.startDate, event.title, event.details, event.durationDays, event.step);
                const label = `${event.title} (${event.startDate.toDateString()})`;
                html += `<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(label)}</a>`;
            });
            calendarLinksOutput.innerHTML = html;
            calendarLinksOutput.classList.remove('hidden');
        }

        function openGoogleCalendarEvents(events) {
            if (!events.length) return;
            const sortedEvents = events.slice().sort((a, b) => a.startDate - b.startDate);
            renderCalendarLinks(sortedEvents);
            sortedEvents.forEach((event, index) => {
                const url = getGoogleCalendarUrl(event.startDate, event.title, event.details, event.durationDays, event.step);
                setTimeout(() => {
                    const newWindow = window.open(url, '_blank', 'noopener');
                    if (newWindow) {
                        newWindow.opener = null;
                    }
                }, index * 200);
            });
        }

        function openPrintableCalendar() {
            if (!plannerCalendar || !plannerCalendar.innerHTML) return;
            const printWindow = window.open('', '_blank', 'noopener');
            if (!printWindow) return;

            const heading = plannerPlantingDate
                ? `Sweet Potato Calendar (Planting: ${plannerPlantingDate.toDateString()})`
                : 'Sweet Potato Calendar';

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${heading}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 24px; color: #1f2933; }
                        h1 { font-size: 20px; margin-bottom: 12px; }
                        .calendar-grid { display: grid; gap: 16px; }
                        .calendar-month { border: 1px solid #cbd2d9; border-radius: 10px; padding: 12px; }
                        .calendar-month-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
                        .calendar-days { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 6px; }
                        .day-name { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; text-align: center; color: #616e7c; font-weight: 700; }
                        .day-cell { min-height: 72px; border: 1px solid #e4e7eb; border-radius: 8px; padding: 4px; font-size: 10px; }
                        .day-cell.is-empty { border-color: transparent; }
                        .day-number { font-weight: 700; display: block; margin-bottom: 4px; }
                        .calendar-event { display: block; margin-bottom: 4px; font-size: 10px; padding: 2px 4px; border-radius: 999px; border: 1px solid #d9b79f; background: transparent; appearance: none; text-align: left; cursor: default; }
                        .event-tooltip { display: none; }
                        .calendar-more { font-size: 9px; color: #7b8794; }
                        .event-orange { background: #fde8d8; border-color: #d45b2b; }
                        .event-blue { background: #e2effb; border-color: #2a6fb0; }
                        .event-green { background: #e7f4ea; border-color: #3f7c4b; }
                        .event-brown { background: #f1e3d7; border-color: #7a4c2b; }
                        .event-gray { background: #f3efe8; border-color: #9c8f7b; }
                        @media print {
                            body { margin: 10mm; }
                            .calendar-month { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${heading}</h1>
                    ${plannerCalendar.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.onload = () => {
                printWindow.print();
            };
        }

        function setupPlannerFilters() {
            if (!plannerFiltersContainer) return;
            plannerFiltersContainer.addEventListener('change', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLInputElement)) return;
                if (target.name === 'status-filter') {
                    plannerFilters.status = target.value;
                } else if (target.type === 'checkbox') {
                    plannerFilters.phases[target.value] = target.checked;
                }
                if (!plannerPlantingDate) return;
                renderPlannerCalendar(plannerPlantingDate, plannerPlannedEvents, plannerCompletedEvents);
            });
        }

        function setupPlannerInteractions() {
            if (!plannerCalendar) return;
            plannerCalendar.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                const eventButton = target.closest('.calendar-event');
                if (!eventButton) return;
                const stepId = eventButton.getAttribute('data-step');
                if (!stepId) return;
                const stepIndex = steps.findIndex((step) => step.id === stepId);
                if (stepIndex === -1) return;
                currentStep = stepIndex;
                setView('guide');
            });
        }

        function isTestMode() {
            return new URLSearchParams(window.location.search).has('test');
        }

        function renderTestResults(results) {
            const panel = document.createElement('div');
            panel.setAttribute('id', 'test-results');
            panel.style.cssText = [
                'position:fixed',
                'bottom:16px',
                'right:16px',
                'max-width:360px',
                'max-height:60vh',
                'overflow:auto',
                'background:#fff',
                'border:2px solid #1f2933',
                'border-radius:12px',
                'padding:12px',
                'font-family:Arial, sans-serif',
                'font-size:12px',
                'box-shadow:0 10px 24px rgba(0,0,0,0.15)',
                'z-index:9999'
            ].join(';');
            const passCount = results.filter(result => result.pass).length;
            const heading = document.createElement('div');
            heading.textContent = `Test Results: ${passCount}/${results.length} passing`;
            heading.style.fontWeight = '700';
            heading.style.marginBottom = '8px';
            panel.appendChild(heading);

            results.forEach((result) => {
                const row = document.createElement('div');
                row.textContent = `${result.pass ? '[PASS]' : '[FAIL]'} ${result.name}${result.details ? ` - ${result.details}` : ''}`;
                row.style.color = result.pass ? '#1a7f37' : '#b42318';
                row.style.marginBottom = '4px';
                panel.appendChild(row);
            });

            document.body.appendChild(panel);
        }

        async function runTests() {
            const results = [];
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const assert = (name, condition, details = '') => {
                results.push({ name, pass: Boolean(condition), details });
            };

            const projectLogSnapshot = JSON.parse(JSON.stringify(projectLog));
            const currentStepSnapshot = currentStep;
            const activeViewSnapshot = activeView;
            const plantingSnapshot = plantingDateInput.value;

            setView('planner');
            plantingDateInput.value = '2025-05-15';
            calculateAndRenderSchedule();
            await wait(50);

            assert('steps length is 11', steps.length === 11, `found ${steps.length}`);
            assert('baseSchedule length is 11', baseSchedule.length === 11, `found ${baseSchedule.length}`);
            assert('planner actions visible', !plannerActions.classList.contains('hidden'));
            assert('calendar months render', plannerCalendar.querySelectorAll('.calendar-month').length > 0);
            assert('calendar events render', plannerCalendar.querySelectorAll('.calendar-event').length > 0);

            projectLog = {
                harvest: {
                    done: true,
                    date: '2025-09-20',
                    entries: [
                        { 'Harvest Date': '2025-09-20', 'Field/Bed ID': 'Bed A', 'Total Harvest (Kg)': '10' }
                    ],
                },
            };
            refreshPlannerCalendar();
            await wait(50);

            const calendarText = plannerCalendar.textContent || '';
            assert('completed events render', calendarText.includes('Completed:'));

            const plannedFilter = plannerFiltersContainer.querySelector('input[name="status-filter"][value="planned"]');
            if (plannedFilter) {
                plannedFilter.checked = true;
                plannedFilter.dispatchEvent(new Event('change', { bubbles: true }));
                await wait(50);
                assert('planned filter hides completed', !(plannerCalendar.textContent || '').includes('Completed:'));
            } else {
                assert('planned filter present', false, 'status filter not found');
            }

            const completedFilter = plannerFiltersContainer.querySelector('input[name="status-filter"][value="completed"]');
            if (completedFilter) {
                completedFilter.checked = true;
                completedFilter.dispatchEvent(new Event('change', { bubbles: true }));
                await wait(50);
                assert('completed filter hides planned', !(plannerCalendar.textContent || '').includes('Planned:'));
            } else {
                assert('completed filter present', false, 'status filter not found');
            }

            const allFilter = plannerFiltersContainer.querySelector('input[name="status-filter"][value="all"]');
            if (allFilter) {
                allFilter.checked = true;
                allFilter.dispatchEvent(new Event('change', { bubbles: true }));
                await wait(50);
            }

            const harvestingFilter = plannerFiltersContainer.querySelector('input[value="harvesting"]');
            if (harvestingFilter) {
                harvestingFilter.checked = false;
                harvestingFilter.dispatchEvent(new Event('change', { bubbles: true }));
                await wait(50);
                assert('harvest filter hides harvest events', !(plannerCalendar.textContent || '').includes('Harvest Tubers'));
                harvestingFilter.checked = true;
                harvestingFilter.dispatchEvent(new Event('change', { bubbles: true }));
                await wait(50);
            } else {
                assert('harvesting filter present', false, 'harvesting filter not found');
            }

            const tooltipExists = plannerCalendar.querySelector('.calendar-event .event-tooltip');
            assert('event tooltips render', Boolean(tooltipExists));

            const firstEvent = plannerCalendar.querySelector('.calendar-event[data-step]');
            if (firstEvent) {
                firstEvent.click();
                await wait(350);
                assert('click opens guide view', activeView === 'guide');
                assert('current step updated', currentStep >= 0);
            } else {
                assert('calendar event is clickable', false, 'no event found to click');
            }

            projectLog = projectLogSnapshot;
            plantingDateInput.value = plantingSnapshot;
            setView(activeViewSnapshot);
            currentStep = currentStepSnapshot;
            if (activeViewSnapshot === 'planner') {
                calculateAndRenderSchedule();
            }

            renderTestResults(results);
        }

        // --- NEW: Collapsible Section Toggle ---
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const toggleBtn = document.querySelector(`[data-controls="${sectionId}"]`);
            if (!content) return;

            const isCollapsed = content.classList.toggle('is-collapsed');
            content.style.maxHeight = isCollapsed ? '0px' : `${content.scrollHeight}px`;
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', String(!isCollapsed));
            }
            const icon = toggleBtn ? toggleBtn.querySelector('.chevron-icon') : null;
            if (icon) {
                icon.classList.toggle('rotate-180', isCollapsed);
            }
        }

        // --- SCHEDULING LOGIC (DYNAMICALLY GENERATED) ---
        
        function getDynamicSchedule() {
            const daysToHarvest = getAssumptionValue('daysToHarvest');
            const daysPropagation = getAssumptionValue('daysPropagation');
            const daysMotherStart = getAssumptionValue('daysMotherStart');
            const daysPrePlantingPrep = getAssumptionValue('daysPrePlantingPrep');
            
            // Calculate offsets based on user inputs
            const scheduleOffsets = {
                // Pre-Planting (offsets are calculated backward from Day 0 Planting)
                'start_mother': -(daysMotherStart + daysPropagation),
                'cut_slips': -daysPropagation - (daysMotherStart / 2), // Estimate cut slips halfway through sprouting
                'root_slips': -daysPropagation,
                'soil_prep': -daysPrePlantingPrep,
                
                // Growing Phase (Day 0 Planting)
                'plant_field': 0,
                'scouting_start': 30, // Fixed start day after planting
                'manage_vines': 45, // Set offset to 45 days post-planting
                
                // Post-Planting (offsets are calculated forward from Day 0 Planting)
                'harvest': daysToHarvest,
                'cure': daysToHarvest, // Curing starts on harvest day
                'storage': daysToHarvest + 10, // Storage starts 10 days after harvest/curing starts
                'sale': daysToHarvest + 10, // Sales can start after curing/storage begins
            };

            const dynamicSchedule = baseSchedule.map(event => {
                let offset = scheduleOffsets[event.id] || 0;
                let duration = event.durationDays;
                
                // Special Duration Overrides (if defined by user inputs)
                if (event.durationKey === 'daysMotherStart') duration = daysMotherStart;
                if (event.durationKey === 'daysPropagation') duration = daysPropagation;
                if (event.durationKey === 'daysPrePlantingPrep') duration = daysPrePlantingPrep;
                if (event.durationKey === 'daysToHarvest') duration = daysToHarvest;
                
                // Special case for scouting, which has fixed days in the baseSchedule definition
                if (event.id === 'scouting_start') duration = event.durationDays; 

                return {
                    ...event,
                    offsetDays: offset,
                    durationDays: duration
                };
            }).sort((a, b) => a.offsetDays - b.offsetDays); // Sort by calculated offset

            return dynamicSchedule;
        }

        function calculateAndRenderSchedule() {
            const plantingDateStr = plantingDateInput.value;
            if (!plantingDateStr) {
                calendarOutput.innerHTML = `<p class="text-gray-500 italic" id="planner-placeholder">
                    Enter a planting date above to see your full schedule.
                </p>`;
                plannerActions.classList.add('hidden');
                plannerCalendarWrap.classList.add('hidden');
                plannerCalendar.innerHTML = '';
                renderCalendarLinks([]);
                return;
            }

            const plantingDate = parseLocalDate(plantingDateStr);
            if (!plantingDate) {
                plannerActions.classList.add('hidden');
                plannerCalendarWrap.classList.add('hidden');
                plannerCalendar.innerHTML = '';
                renderCalendarLinks([]);
                return;
            }
            
            const dynamicSchedule = getDynamicSchedule();
            const plannedEvents = buildPlannedEvents(dynamicSchedule, plantingDate);
            const completedEvents = buildCompletedEvents();
            plannerPlantingDate = plantingDate;
            plannerPlannedEvents = plannedEvents;
            plannerCompletedEvents = completedEvents;
            renderCalendarLinks([]);
            let html = '<ul class="space-y-4">';
            let prevDate = null;

            plannedEvents.forEach((event) => {
                const eventDate = event.startDate;
                const readableDate = eventDate.toDateString();
                
                // Calculate days from previous event (only used for display, not logic)
                let daysDifference = '';
                if (prevDate) {
                    const diffTime = Math.abs(eventDate.getTime() - prevDate.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 0) {
                        daysDifference = `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full ml-3">Wait ${diffDays} days from previous step</span>`;
                    }
                }
                prevDate = eventDate;

                // Duration for Calendar is at least 1 day
                const duration = event.durationDays || 1; 

                const calendarUrl = getGoogleCalendarUrl(eventDate, event.title, event.details, duration, event.step);
                const colorClass = COLORS[event.color] || 'border-gray-500 bg-gray-100';

                html += `
                    <li class="p-3 border-l-4 ${colorClass} rounded-md">
                        <div class="flex items-center justify-between">
                            <p class="font-bold text-lg text-gray-800 flex items-center">
                                ${event.icon} ${event.title}
                            </p>
                            ${daysDifference}
                        </div>
                        <p class="text-sm text-gray-700 mt-1">
                            Date: <span class="font-semibold">${readableDate}</span>
                            <span class="ml-4 text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded-full">Phase: ${event.phase}</span>
                            <span class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">${event.durationDays > 1 ? event.durationDays + ' Day Duration' : 'Single Day Event'}</span>
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            <span class="font-medium">Details:</span> ${event.details}
                        </p>
                        <a href="${calendarUrl}" target="_blank" rel="noopener noreferrer" class="mt-2 inline-block text-xs font-bold text-blue-600 hover:text-blue-800 transition duration-150">
                            + Add Single Event to Calendar
                        </a>
                    </li>
                `;
            });

            html += '</ul>';
            calendarOutput.innerHTML = html;
            renderPlannerCalendar(plantingDate, plannedEvents, completedEvents);
            
            // Update the Add All button event handler with the calculated dates
            addAllBtn.onclick = () => {
                openGoogleCalendarEvents(plannedEvents);
            };
            if (downloadIcsBtn) {
                downloadIcsBtn.onclick = () => {
                    downloadCalendarIcs([...plannedEvents, ...completedEvents]);
                };
            }
            if (printCalendarBtn) {
                printCalendarBtn.onclick = () => {
                    openPrintableCalendar();
                };
            }
            plannerActions.classList.remove('hidden');
        }

        // --- ACTIVITY LOG LOGIC (REFACTORED) ---
        
        function renderLog() {
            let html = '';
            steps.forEach((step, index) => {
                // Find corresponding schedule data for log fields
                const logData = baseSchedule.find(d => d.step === index + 1);
                
                // Skip steps that have no loggable fields (like 7, 9, 10, 11)
                // UPDATED: This check is now dynamic based on logFields.
                if (!logData || !logData.logFields || logData.logFields.length === 0) return; 

                const stepLog = projectLog[step.id] || { done: false, date: '', entries: [] };
                
                // Render the individual entries for this step
                let entriesHtml = '<div class="space-y-3 mt-4">';
                stepLog.entries.forEach((entry, entryIndex) => {
                    entriesHtml += renderLogEntry(step.id, entryIndex, logData.logFields, entry);
                });
                entriesHtml += '</div>';

                const contentId = `log-content-${step.id}`;

                html += `
                    <div class="p-4 activity-log-card bg-white rounded-lg border-l-4 ${stepLog.done ? 'border-green-600' : 'border-gray-300'}">
                        <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('${contentId}')" data-controls="${contentId}" aria-controls="${contentId}" aria-expanded="true">
                            <p class="font-bold text-gray-700">${step.visual.replace(/‚Üí/g, '‚Üí')} Step ${index + 1}: ${step.title}</p>
                            <div class="flex items-center">
                                <label class="flex items-center space-x-2 mr-4" onclick="event.stopPropagation();">
                                    <input type="checkbox" ${stepLog.done ? 'checked' : ''} onchange="toggleDone('${step.id}', this.checked)" class="h-5 w-5 text-green-600 rounded">
                                    <span class="text-sm font-medium text-gray-600">Done</span>
                                </label>
                                <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                        </button>
                        
                        <div id="${contentId}" class="collapsible-content mt-4">
                            <label for="${step.id}-date" class="block text-sm font-medium text-gray-700 mt-2">Overall Completion Date (for this step):</label>
                            <input type="date" id="${step.id}-date" value="${stepLog.date}" onchange="updateDate('${step.id}', this.value)" class="p-2 border rounded-md shadow-inner w-full mb-3 text-sm">
                            
                            <h5 class="font-semibold text-gray-700 mt-4 border-t pt-3">Data Entries:</h5>
                            ${entriesHtml}
                            
                            <button onclick="addLogEntry('${step.id}')" class="mt-4 w-full btn-secondary py-2 text-sm rounded-lg font-semibold">
                                + Add New Entry for Step ${index + 1}
                            </button>
                            <p id="${step.id}-status" class="text-xs text-green-600 mt-2 font-medium"></p>
                        </div>
                    </div>
                `;
            });

            logEntriesContainer.innerHTML = html;

            // Update status messages after rendering (important for dynamic content)
            for (const key in projectLog) {
                const statusElement = document.getElementById(`${key}-status`);
                if (statusElement && projectLog[key].done) {
                    const dateText = projectLog[key].date || 'N/A';
                    statusElement.textContent = `Step marked complete on: ${dateText}.`;
                }
            }
            syncCollapsibleHeights(logEntriesContainer);
        }

        function renderLogEntry(stepId, entryIndex, logFields, entryData) {
            let fieldsHtml = '';
            logFields.forEach(field => {
                const value = entryData[field.label] ?? '';
                const placeholder = field.placeholder || `Enter ${field.label}`;
                if (field.type === 'textarea') {
                    fieldsHtml += `
                        <label class="block text-sm font-medium text-gray-700">${field.label}:</label>
                        <textarea onchange="updateLogEntry('${stepId}', ${entryIndex}, '${field.label}', this.value)"
                            placeholder="${placeholder}"
                            class="p-2 border rounded-md shadow-inner w-full mb-2 text-sm">${value}</textarea>
                    `;
                } else {
                    fieldsHtml += `
                        <label class="block text-sm font-medium text-gray-700">${field.label}:</label>
                        <input type="${field.type}" value="${value}" 
                            onchange="updateLogEntry('${stepId}', ${entryIndex}, '${field.label}', this.value)"
                            placeholder="${placeholder}" 
                            class="p-2 border rounded-md shadow-inner w-full mb-2 text-sm">
                    `;
                }
            });

            return `
                <div class="p-3 bg-gray-50 rounded-lg border log-entry-card">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold text-gray-600">Entry ${entryIndex + 1}</p>
                        <button onclick="removeLogEntry('${stepId}', ${entryIndex})" 
                            class="text-xs text-red-600 font-semibold hover:text-red-800">
                            Remove
                        </button>
                    </div>
                    ${fieldsHtml}
                </div>
            `;
        }

        function addLogEntry(stepId) {
            projectLog[stepId] = projectLog[stepId] || { done: false, date: '', entries: [] };
            
            const logData = baseSchedule.find(d => d.step === steps.findIndex(s => s.id === stepId) + 1);
            if (!logData) return;

            const newEntry = {};
            logData.logFields.forEach(field => {
                newEntry[field.label] = ''; // Initialize with empty values
            });

            projectLog[stepId].entries.push(newEntry);
            renderLog(); // Re-render the log to show the new entry form
            refreshPlannerCalendar();
        }

        function removeLogEntry(stepId, entryIndex) {
            const stepLog = projectLog[stepId];
            if (stepLog && stepLog.entries[entryIndex]) {
                stepLog.entries.splice(entryIndex, 1);
                renderLog(); // Re-render
                refreshPlannerCalendar();
            }
        }

        function updateLogEntry(stepId, entryIndex, label, value) {
            const entry = projectLog[stepId]?.entries[entryIndex];
            if (entry) {
                entry[label] = value;
                // Data is saved in the projectLog object, no need to re-render just for a value change
                refreshPlannerCalendar();
            }
        }

        function toggleDone(id, isChecked) {
            projectLog[id] = projectLog[id] || { done: false, date: '', entries: [] };
            projectLog[id].done = isChecked;
            if (isChecked && !projectLog[id].date) {
                // Set today's date if marked done but no date exists
                projectLog[id].date = new Date().toISOString().substring(0, 10);
            } 
            renderLog();
            refreshPlannerCalendar();
        }

        function updateDate(id, dateValue) {
            projectLog[id] = projectLog[id] || { done: false, date: '', entries: [] };
            projectLog[id].date = dateValue;
            if (dateValue && !projectLog[id].done) {
                // Mark done if a date is manually entered
                projectLog[id].done = true;
            } 
            renderLog();
            refreshPlannerCalendar();
        }


        // --- REPORTING LOGIC ---
        function renderReport(isRefresh = false) {
            if (!isRefresh && Object.keys(projectLog).length === 0) {
                // Only show placeholder if not a manual refresh AND there is no data
                reportOutput.innerHTML = `<p class="text-gray-500 italic">Click "Refresh Report" to see your project data.</p>`;
                return;
            }

            // Calculations
            const mothers = projectLog['start_mother']?.entries || [];
            const slipsCut = projectLog['cut_slips']?.entries || [];
            const slipsRooted = projectLog['root_slips']?.entries || [];
            const slipsPlanted = projectLog['plant_field']?.entries || [];
            const soilTests = projectLog['soil_prep']?.entries || [];
            const pestSightings = projectLog['scouting']?.entries || [];
            const harvests = projectLog['harvest']?.entries || [];
            const sales = projectLog['sale']?.entries || []; // NEW: Get sales data

            // Totals
            const totalMothers = mothers.length;
            const totalSlipsCut = slipsCut.reduce((sum, entry) => sum + (parseFloat(entry['Slips Cut']) || 0), 0);
            const totalSlipsRooted = slipsRooted.reduce((sum, entry) => sum + (parseFloat(entry['Slips Put in Water']) || 0), 0);
            const totalSlipsPlanted = slipsPlanted.reduce((sum, entry) => sum + (parseFloat(entry['Slips Planted']) || 0), 0);
            const totalHarvestKg = harvests.reduce((sum, entry) => sum + (parseFloat(entry['Total Harvest (Kg)']) || 0), 0);
            const totalSoldKg = sales.reduce((sum, entry) => sum + (parseFloat(entry['Quantity Sold (Kg)']) || 0), 0); // NEW
            const totalRevenue = sales.reduce((sum, entry) => { // NEW
                const qty = parseFloat(entry['Quantity Sold (Kg)']) || 0;
                const price = parseFloat(entry['Price per Kg ($)']) || 0;
                return sum + (qty * price);
            }, 0);

            // Calculate Averages
            const avgPH = soilTests.length > 0 
                ? (soilTests.reduce((sum, entry) => sum + (parseFloat(entry['Soil pH']) || 0), 0) / soilTests.length).toFixed(2)
                : 'N/A';
            
            const avgHarvestPerPlanting = harvests.length > 0
                ? (totalHarvestKg / harvests.length).toFixed(2)
                : 'N/A';
            
            const avgPricePerKg = totalSoldKg > 0 // NEW
                ? (totalRevenue / totalSoldKg).toFixed(2)
                : 'N/A';
            
            // Build Report HTML
            let html = `
                <h4 class="text-2xl font-bold text-gray-800 mb-4">Project Summary Report</h4>
                
                <!-- Summary Metrics -->
                <div class="report-section bg-gray-50 p-4 rounded-lg mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-totals')" data-controls="report-totals" aria-controls="report-totals" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Key Totals</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-totals" class="collapsible-content mt-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-orange-600">${totalMothers}</p>
                                <p class="text-sm font-medium text-gray-600">Mother Tubers</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-blue-600">${totalSlipsCut}</p>
                                <p class="text-sm font-medium text-gray-600">Slips Cut</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-600">${totalSlipsPlanted}</p>
                                <p class="text-sm font-medium text-gray-600">Slips Planted</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-yellow-700">${totalHarvestKg.toFixed(1)} Kg</p>
                                <p class="text-sm font-medium text-gray-600">Total Harvest</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Financial Metrics -->
                <div class="report-section bg-gray-50 p-4 rounded-lg mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-financials')" data-controls="report-financials" aria-controls="report-financials" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Financial Summary</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-financials" class="collapsible-content mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-600">$${totalRevenue.toFixed(2)}</p>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-700">${totalSoldKg.toFixed(1)} Kg</p>
                                <p class="text-sm font-medium text-gray-600">Total Kg Sold</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-800">$${avgPricePerKg}</p>
                                <p class="text-sm font-medium text-gray-600">Avg. Price / Kg</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Propagation Funnel -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-funnel')" data-controls="report-funnel" aria-controls="report-funnel" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Propagation Funnel</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-funnel" class="collapsible-content mt-4">
                        <div class="flex flex-col md:flex-row gap-2 text-center items-center">
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <p class="text-2xl font-bold">${totalSlipsCut}</p>
                                <p class="text-sm font-medium">Slips Cut</p>
                            </div>
                            <p class="text-2xl font-bold text-gray-400 mx-2">‚Üí</p>
                            <div class="p-3 bg-blue-200 rounded-lg">
                                <p class="text-2xl font-bold">${totalSlipsRooted}</p>
                                <p class="text-sm font-medium">Slips Rooted</p>
                            </div>
                            <p class="text-2xl font-bold text-gray-400 mx-2">‚Üí</p>
                            <div class="p-3 bg-green-200 rounded-lg">
                                <p class="text-2xl font-bold">${totalSlipsPlanted}</p>
                                <p class="text-sm font-medium">Slips Planted</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Harvest Details -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-harvest')" data-controls="report-harvest" aria-controls="report-harvest" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Harvest Log (Total: ${totalHarvestKg.toFixed(1)} Kg, Avg: ${avgHarvestPerPlanting} Kg/Entry)</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-harvest" class="collapsible-content mt-4">
                        ${createTableHtml(harvests, ['Harvest Date', 'Field/Bed ID', 'Total Harvest (Kg)'])}
                    </div>
                </div>

                <!-- Pest Log -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-pest')" data-controls="report-pest" aria-controls="report-pest" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Pest & Disease Log (${pestSightings.length} sightings)</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-pest" class="collapsible-content mt-4">
                        ${createTableHtml(pestSightings, ['Date Sighted', 'Pest/Disease Name', 'GPS (Lat, Lon)', 'Notes/Action Taken'])}
                    </div>
                </div>

                <!-- Soil Tests -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-soil')" data-controls="report-soil" aria-controls="report-soil" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Soil Test Log (Avg. pH: ${avgPH})</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-soil" class="collapsible-content mt-4">
                        ${createTableHtml(soilTests, ['Date Tested', 'Field/Bed ID', 'Soil pH'])}
                    </div>
                </div>

                <!-- NEW: Sales Log -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-sales')" data-controls="report-sales" aria-controls="report-sales" aria-expanded="true">
                        <h5 class="text-xl font-semibold text-gray-700">Sales Log (Total: $${totalRevenue.toFixed(2)})</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-sales" class="collapsible-content mt-4">
                        ${createTableHtml(sales, ['Sale Date', 'Quantity Sold (Kg)', 'Price per Kg ($)', 'Customer/Market'])}
                    </div>
                </div>
            `;

            reportOutput.innerHTML = html;
            syncCollapsibleHeights(reportOutput);
        }

        function printReport() {
            setView('reporting');
            renderReport(true);
            requestAnimationFrame(() => {
                reportOutput.querySelectorAll('.collapsible-content').forEach((section) => {
                    section.classList.remove('is-collapsed');
                });
                syncCollapsibleHeights(reportOutput);
                window.print();
            });
        }

        function createTableHtml(data, headers) {
            if (data.length === 0) {
                return '<p class="text-gray-500 italic">No data logged for this category.</p>';
            }
            
            let table = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            // Header
            table += '<thead class="bg-gray-50"><tr>';
            headers.forEach(header => {
                table += `<th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`;
            });
            table += '</tr></thead>';
            
            // Body
            table += '<tbody class="bg-white divide-y divide-gray-200">';
            data.forEach(entry => {
                table += '<tr>';
                headers.forEach(header => {
                    table += `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${entry[header] ?? ''}</td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        function downloadReport() {
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectLog, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "sweet_potato_log.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            } catch (error) {
                console.error("Failed to download JSON:", error);
                // We can't use alert(), so we'll log to console
            }
        }


        // --- UI VIEW MANAGEMENT ---

        function setView(viewName) {
            activeView = viewName;

            // Hide all content areas
            contentArea.classList.add('hidden');
            stepActions.classList.add('hidden');
            plannerTool.classList.add('hidden');
            projectLogTool.classList.add('hidden');
            reportingTool.classList.add('hidden');
            progressContainer.classList.add('hidden');
            guideFooter.classList.add('hidden');
            setActiveTab(viewName);

            // Show active content area and set button style
            if (viewName === 'guide') {
                contentArea.classList.remove('hidden');
                progressContainer.classList.remove('hidden');
                guideFooter.classList.remove('hidden');
                stepActions.classList.remove('hidden');
                renderStep();
            } else if (viewName === 'planner') {
                plannerTool.classList.remove('hidden');
                calculateAndRenderSchedule();
            } else if (viewName === 'log') {
                projectLogTool.classList.remove('hidden');
                renderLog();
            } else if (viewName === 'reporting') {
                reportingTool.classList.remove('hidden');
                renderReport(true); // Render report immediately
            }
        }
        
        // --- GUIDE RENDERING LOGIC ---

        function renderStep() {
            contentArea.style.opacity = '0';
            setTimeout(() => {
                const step = steps[currentStep];
                const stepNum = currentStep + 1;
                
                // Render the clean visual symbols
                stepIcon.innerHTML = `<p class="text-5xl font-extrabold text-gray-800">${step.visual.replace(/‚Üí/g, '<span class="text-4xl mx-2 text-orange-500">‚Üí</span>')}</p>`;
                
                stepTitle.textContent = step.title;
                
                // Directly set the description (now that the source data is clean)
                stepDescription.innerHTML = `<p class="mb-3">${step.description.replace(/\n\n/g, '</p><p class="mb-3">')}</p>`;
                
                // Render Action Buttons
                stepActions.innerHTML = `
                    <button onclick="setView('planner')" class="link-btn mr-3">
                        View Date in Planner
                    </button>
                    <button onclick="setView('log')" class="link-btn">
                        Log Step ${stepNum} Completion
                    </button>
                `;

                const progressPercentage = (stepNum / steps.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `Guide Step ${stepNum} of ${steps.length}`;

                prevBtn.disabled = currentStep === 0;
                prevBtn.classList.toggle('opacity-50', currentStep === 0);

                if (currentStep === steps.length - 1) {
                    nextBtn.textContent = 'Guide Complete! üéâ';
                    nextBtn.classList.remove('btn-primary');
                    nextBtn.classList.add('btn-secondary');
                } else {
                    nextBtn.textContent = 'Next Step ‚Üí';
                    nextBtn.classList.remove('btn-secondary');
                    nextBtn.classList.add('btn-primary');
                }

                contentArea.style.opacity = '1';
            }, 300);
        }

        // --- NAVIGATION HANDLERS ---
        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep();
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }
        
        // --- EVENT LISTENERS ---

        // Navigation
        prevBtn.addEventListener('click', prevStep);
        nextBtn.addEventListener('click', nextStep);
        
        // View Toggles
        Object.entries(viewButtons).forEach(([view, button]) => {
            button.addEventListener('click', () => setView(view));
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            setView('guide'); // Start on the guide page
            // Add listener for download button
            // We must add it here because the button is part of the reporting-tool div
            const downloadBtn = document.getElementById('download-json-btn');
            if(downloadBtn) {
                downloadBtn.addEventListener('click', downloadReport);
            }
            setupPlannerFilters();
            setupPlannerInteractions();
            if (isTestMode()) {
                runTests().catch((error) => {
                    console.error('Test harness failed:', error);
                });
            }
        };
        
    </script>
</body>
</html>


