<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Potato Farming and Tracking Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Cartoon Look (Restored from V1) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root {
            --color-primary: #D35400; /* Darker Orange/Terra Cotta */
            --color-secondary: #F1C40F; /* Sunflower Yellow */
            --color-accent: #27AE60; /* Emerald Green */
            --color-bg: #ECF0F1; /* Light Gray/Cloud */
        }
        body {
            background-color: var(--color-bg);
            font-family: 'Inter', sans-serif;
        }
        .guide-card {
            box-shadow: 12px 12px 0px var(--color-accent);
            border: 5px solid var(--color-accent);
        }
        .btn-primary {
            background-color: var(--color-primary);
            border: 3px solid #A04000;
            color: white;
            transition: all 0.1s ease-in-out;
            box-shadow: 4px 4px 0px #A04000;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #A04000;
        }
        .btn-primary:active {
            transform: translateY(4px);
            box-shadow: 0px 0px 0px #A04000;
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            border: 3px solid #B7950B;
            color: #333;
            transition: all 0.1s ease-in-out;
            box-shadow: 4px 4px 0px #B7950B;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #B7950B;
        }
        .btn-secondary:active {
            transform: translateY(4px);
            box-shadow: 0px 0px 0px #B7950B;
        }
        /* Added style for the new Reporting button */
        .btn-tertiary {
            background-color: #e0e7ff;
            border: 3px solid #a5b4fc;
            color: #3730a3;
            transition: all 0.1s ease-in-out;
            box-shadow: 4px 4px 0px #a5b4fc;
        }
        .btn-tertiary:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #a5b4fc;
        }
        .btn-tertiary:active {
            transform: translateY(4px);
            box-shadow: 0px 0px 0px #a5b4fc;
        }
        .step-content {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom Colors for Activity Types */
        .color-green { border-color: #27AE60; background-color: #E8F5E9; } /* Planting */
        .color-orange { border-color: #FF9800; background-color: #FFF3E0; } /* Sprouting/Curing */
        .color-blue { border-color: #2196F3; background-color: #E3F2FD; } /* Rooting/Water */
        .color-brown { border-color: #795548; background-color: #EFEBE9; } /* Harvesting */
        .color-gray { border-color: #9E9E9E; background-color: #FAFAFA; } /* Storage/Sale */

        .activity-log-card {
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        }
        .log-entry-card {
            box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }
        .link-btn {
            background-color: #E0E7FF;
            color: #3B82F6;
            border: 1px solid #93C5FD;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.1s;
        }
        .link-btn:hover {
            background-color: #C7D2FE;
        }
        
        /* NEW Styles for Collapsible Sections */
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out;
            max-height: 2000px; /* Set to a large value */
            opacity: 1;
        }
        .collapsible-content.hidden {
            max-height: 0;
            opacity: 0;
        }
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        .chevron-icon.rotate-180 {
            transform: rotate(180deg);
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white;
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 0;
            }
            .guide-card {
                box-shadow: none;
                border: none;
                max-width: 100%;
                padding: 0;
            }
            header, #guide-footer, .no-print {
                display: none;
            }
            #reporting-tool {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            .report-section {
                margin-top: 2rem;
                padding: 1rem;
                border: 1px solid #ccc;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .collapsible-content {
                max-height: none !important;
                opacity: 1 !important;
                display: block !important;
            }
            .chevron-icon {
                display: none;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2;
            }
        }
    </style>
</head>
<body class="p-4 flex items-start justify-center min-h-screen pt-8">

    <!-- Main Guide Card -->
    <div id="guide-card" class="guide-card max-w-2xl w-full bg-white rounded-xl p-6 md:p-8">

        <!-- Title and Progress -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-5xl font-extrabold text-gray-800 text-center mb-1">
                Sweet Potato Farming and Tracking Guide üç†
            </h1>
            <p class="text-center text-gray-500 font-medium mb-4">
                Smart Steps for Growing, Tracking, and Selling (11 Phases)
            </p>
            
            <!-- Planner and Log Toggle Tabs -->
            <div class="grid grid-cols-3 space-x-2 mb-4">
                <button id="toggle-guide-btn" class="flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm">
                    Step-by-Step Guide
                </button>
                <button id="toggle-planner-btn" class="flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm">
                    Crop Planner üóìÔ∏è
                </button>
                <button id="toggle-log-btn" class="flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm">
                    My Project Log ‚úÖ
                </button>
                <button id="toggle-reporting-btn" class="col-span-3 mt-2 flex-1 btn-tertiary px-4 py-2 rounded-lg font-bold text-sm">
                    Reporting & Analysis üìä
                </button>
            </div>
            
            <!-- Planner Tool Area (Starts Hidden) -->
            <div id="planner-tool" class="hidden mt-4 p-4 bg-gray-100 rounded-lg border-2 border-gray-300">
                <h3 class="text-xl font-bold mb-2 text-gray-700">Crop Planting Scheduler <button onclick="setView('guide')" class="link-btn ml-3">Go to Guide</button></h3>
                <p class="text-sm mb-3 text-gray-600">
                    Choose when you want to plant your slips to calculate key dates based on your local assumptions below.
                    <span class="font-bold text-red-600">You must set your planting date below to see the schedule!</span>
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                    <label for="planting-date" class="font-semibold text-gray-700 w-full sm:w-auto">My Planting Date (Step 5):</label>
                    <input type="date" id="planting-date" class="p-2 border rounded-md shadow-inner flex-1 w-full" onchange="calculateAndRenderSchedule()">
                </div>
                
                <h4 class="font-bold text-gray-700 mb-2">Schedule Assumptions (Adjust for your Geography):</h4>
                <div id="assumption-inputs" class="text-sm bg-white p-4 rounded-md border grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    
                    <label class="block">
                        <span class="text-gray-700 font-medium">Days from Planting to Harvest</span>
                        <input type="number" id="daysToHarvest" value="120" min="90" max="180" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Key variable based on variety and climate.</p>
                    </label>

                    <label class="block">
                        <span class="text-gray-700 font-medium">Days for Slip Rooting (in water)</span>
                        <input type="number" id="daysPropagation" value="14" min="7" max="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Time needed to grow 1-inch roots on slips (Step 3).</p>
                    </label>

                    <label class="block">
                        <span class="text-gray-700 font-medium">Days for Mother Sprouting</span>
                        <input type="number" id="daysMotherStart" value="35" min="20" max="60" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Time needed for mother potato to produce slips (Step 1-2).</p>
                    </label>
                    
                    <label class="block">
                        <span class="text-gray-700 font-medium">Days for Field Preparation</span>
                        <input type="number" id="daysPrePlantingPrep" value="7" min="1" max="14" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-base" onchange="calculateAndRenderSchedule()">
                        <p class="text-xs text-gray-500 mt-1">Time needed for soil testing and mounding (Step 4).</p>
                    </label>
                </div>

                <div id="calendar-output" class="mt-4 space-y-3 p-3 bg-white rounded-lg border">
                    <p class="text-gray-500 italic" id="planner-placeholder">
                        Enter a planting date above to see your full schedule.
                    </p>
                    <!-- Calendar links will be inserted here -->
                </div>

                <button id="add-all-btn" class="btn-primary w-full mt-4 px-6 py-2 rounded-lg font-bold text-sm hidden">
                    + Add ALL Events to Google Calendar
                </button>
            </div>

            <!-- Project Log Area (Starts Hidden) -->
            <div id="project-log-tool" class="hidden mt-4 p-4 bg-gray-100 rounded-lg border-2 border-gray-300">
                <h3 class="text-xl font-bold mb-4 text-gray-700">My Project Activity Log <button onclick="setView('guide')" class="link-btn ml-3">Go to Guide</button></h3>
                
                <p class="text-sm text-gray-600 mb-4">Use this log to mark steps complete, record the date you did them, and add multiple data entries for key metrics. Click a step title to expand or collapse it.</p>

                <div id="log-entries" class="space-y-4">
                    <!-- Log fields for each step will be inserted here -->
                </div>
            </div>

            <!-- Reporting Tool Area (Starts Hidden) -->
            <div id="reporting-tool" class="hidden mt-4 p-4 bg-gray-100 rounded-lg border-2 border-gray-300">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Reporting & Analysis <button onclick="setView('guide')" class="link-btn ml-3">Go to Guide</button></h3>
                <div class="flex gap-4 mb-4 no-print">
                    <button onclick="renderReport(true)" class="flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm">
                        Refresh Report
                    </button>
                    <button onclick="window.print()" class="flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm">
                        Print Report
                    </button>
                    <button id="download-json-btn" class="flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm">
                        Download Data (JSON)
                    </button>
                </div>
                <div id="report-output" class="p-4 bg-white rounded-lg border">
                    <p class="text-gray-500 italic">Click "Refresh Report" to see your project data.</p>
                </div>
            </div>


            <!-- Progress Bar (Only visible with Guide) -->
            <div id="progress-container" class="mt-6">
                <p id="progress-text" class="text-sm text-center text-gray-600 font-medium mb-1"></p>
                <div class="h-3 bg-gray-300 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-3 bg-yellow-500 transition-all duration-500" style="width: 0%;"></div>
                </div>
            </div>

        </header>

        <!-- Step Content Area (Only visible with Guide) -->
        <div id="content-area" class="step-content">
            <div id="step-icon" class="text-6xl text-center mb-4 font-extrabold text-gray-800"></div>
            <h2 id="step-title" class="text-2xl font-bold text-gray-700 mb-3 text-center"></h2>
            <p id="step-description" class="text-gray-600 text-lg leading-relaxed"></p>
            <div id="step-actions" class="mt-4 text-center"></div>
        </div>

        <!-- Navigation Buttons (Only visible with Guide) -->
        <footer id="guide-footer" class="mt-8 flex justify-between gap-4">
            <button id="prev-btn" class="btn-secondary px-6 py-3 rounded-xl font-bold w-1/2 md:w-auto flex-1" disabled>
                &larr; Previous
            </button>
            <button id="next-btn" class="btn-primary px-6 py-3 rounded-xl font-bold w-1/2 md:w-auto flex-1">
                Next Step &rarr;
            </button>
        </footer>

    </div>

    <script>
        // --- DATA & ASSUMPTIONS ---

        // Guide Steps (Cleaned up: All LaTeX artifacts removed from descriptions)
        const steps = [
            { id: 'start_mother', title: '1. Start the Mother Potato', 
                description: "Choose a healthy sweet potato. Stick 3 or 4 small sticks (like toothpicks) into the middle. Put the bottom half of the potato in a jar of water and put it in a sunny spot. This is the **Sprouting Phase**.", 
                visual: "ü•î ‚Üí üìå ‚Üí üíß‚òÄÔ∏è"
            },
            { id: 'cut_slips', title: '2. Master Slip Cutting', 
                description: "Propagate Many Plants! When a slip is about 4 fingers long (4-6 inches), cut or twist it off the mother potato above the water line. Use the <span class=\"font-bold\">Project Log</span> to track how many slips you cut.", 
                visual: "üç†üåø ‚Üí ‚úÇÔ∏è ‚Üí üåø" 
            },
            { id: 'root_slips', title: '3. Make the Slips Grow Roots', 
                description: "Put the cut slips into a new jar of clean water, leaf-side up. Change the water every 2 days. Wait until the roots are about 1 inch long. This is the **Rooting Phase**.", 
                visual: "üåø ‚Üí üíß ‚Üí üå±"
            },
            { id: 'soil_prep', title: '4. Smart Step: Soil Test & Field Prep', 
                description: "Before planting, take a soil sample and test the pH (ideally 5.8-6.2). Prepare **raised dirt mounds** about 1-2 steps apart to ensure good drainage. Log your pH reading in the <span class=\"font-bold\">Project Log</span>.", 
                visual: "üçö ‚Üí pH ‚Üí ‚õ∞Ô∏è"
            },
            { id: 'plant_field', title: '5. Plant in the Soil (Day 0)', 
                description: "Plant the rooted slips into the mounds, burying the roots and most of the stem. Sweet potatoes need full sun, all day. This begins the **Growing Phase**.", 
                visual: "üå± ‚Üí ‚õ∞Ô∏è ‚Üí üí¶"
            },
            { id: 'scouting', title: '6. Smart Step: Pest and Disease Scouting', 
                description: "During the first 60 days of growth, actively scout your field. Check the underside of leaves for insects or signs of disease. Early detection is key! Log any sightings in the <span class=\"font-bold\">Project Log</span>.", 
                visual: "üîé ‚Üí üåø ‚Üí üêû"
            },
            { id: 'manage_vines', title: '7. Care for the Vines (Pruning)', 
                description: "Water regularly, but let the soil dry out slightly between waterings. If the vines start growing extra roots down into the soil, **cut these extra roots** to force the plant to focus energy on the main tubers.", 
                visual: "üåø ‚Üí ‚úÇÔ∏è ‚Üí üç† (BIG)"
            },
            { id: 'harvest', title: '8. Know When to Harvest', 
                description: "Tubers are ready 90 to 180 days after planting, signaled when vines turn yellow and die back. Dig carefully and remember to log your **Total Harvest (Kg)** in the <span class=\"font-bold\">Project Log</span>!", 
                visual: "üçÇ ‚Üí ‚õèÔ∏è ‚Üí üß∫"
            },
            { id: 'cure', title: '9. Curing for Sweetness', 
                description: "Gently brush off dirt (do NOT wash). Cure them in a warm, dry, dark room (around 75-85¬∞F) for 10 days. This heals cuts and turns starch to sugar.", 
                visual: "üç† ‚Üí üî•üîí ‚Üí üç¨"
            },
            { id: 'storage', title: '10. Storage for Later', 
                description: "Move cured potatoes to a cool, dry place (55-60¬∞F), dark and well-ventilated. Properly stored sweet potatoes can last up to a year!", 
                visual: "üç¨ ‚Üí üì¶ ‚Üí ‚ùÑÔ∏è"
            },
            { id: 'sale', title: '11. Selling Your Crop', 
                description: "Sort potatoes by size and quality. Use health facts (Vitamin A!) to market your crop effectively.", 
                visual: "üç† ‚Üí üè∑Ô∏è ‚Üí ü§ù"
            }
        ];

        // Base Schedule Definitions (used for log fields and relative step ordering)
        // UPDATED with new logFields structure
        const baseSchedule = [
            { id: 'start_mother', step: 1, activity: 'Start Mother Tuber', color: 'orange', durationKey: 'daysMotherStart', icon: 'üíß', phase: 'Sprouting', 
                logFields: [
                    { label: 'Date Started', type: 'date' },
                    { label: 'Tuber ID/Name', type: 'text', placeholder: 'e.g., Mother A' },
                    { label: 'Generation', type: 'text', placeholder: 'e.g., G0, G1' },
                    { label: 'Source', type: 'text', placeholder: 'e.g., Store, Saved' }
                ], 
                details: 'Place mother potato in water to begin slip production.' 
            },
            { id: 'cut_slips', step: 2, activity: 'Cut Slips', color: 'blue', icon: '‚úÇÔ∏è', phase: 'Sprouting',
                logFields: [
                    { label: 'Date Cut', type: 'date' },
                    { label: 'From Tuber ID', type: 'text', placeholder: 'e.g., Mother A' },
                    { label: 'Slips Cut', type: 'number', placeholder: 'e.g., 15' }
                ],
                details: 'Cut slips from mother tubers.'
            },
            { id: 'root_slips', step: 3, activity: 'Start Rooting Slips', color: 'blue', durationKey: 'daysPropagation', icon: '‚úÇÔ∏è', phase: 'Rooting', 
                logFields: [
                    { label: 'Date Rooting Started', type: 'date' },
                    { label: 'Slips Put in Water', type: 'number', placeholder: 'e.g., 15' }
                ], 
                details: 'Cut slips and place them in water to grow roots.' 
            },
            { id: 'soil_prep', step: 4, activity: 'Soil Test & Field Prep', color: 'gray', durationKey: 'daysPrePlantingPrep', icon: '‚õ∞Ô∏è', phase: 'Field Prep', 
                logFields: [
                    { label: 'Date Tested', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Soil pH', type: 'number', placeholder: 'e.g., 6.1' }
                ], 
                details: 'Test soil pH and prepare mounds for planting.' 
            },
            { id: 'plant_field', step: 5, activity: 'Plant Slips in Field (Day 0)', color: 'green', durationKey: 'daysToHarvest', icon: 'üå±', phase: 'Growing', 
                logFields: [
                    { label: 'Date Planted', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Slips Planted', type: 'number', placeholder: 'e.g., 50' }
                ], 
                details: 'Plant rooted slips in warm, mounded soil.' 
            },
            { id: 'scouting_start', step: 6, activity: 'Pest/Disease Scouting', color: 'blue', fixedStartDays: 30, durationDays: 60, icon: 'üîé', phase: 'Monitoring', 
                logFields: [
                    { label: 'Date Sighted', type: 'date' },
                    { label: 'Pest/Disease Name', type: 'text', placeholder: 'e.g., Aphids' },
                    { label: 'GPS (Lat, Lon)', type: 'text', placeholder: 'e.g., 40.71, -74.00' },
                    { label: 'Notes/Action Taken', type: 'textarea', placeholder: 'Spotted on 3 plants...' }
                ], 
                details: 'Active monitoring period for pests and disease (Days 30-90).' 
            },
            { id: 'manage_vines', step: 7, activity: 'Vine Management (Pruning)', color: 'green', icon: '‚úÇÔ∏è', phase: 'Monitoring',
                logFields: [
                    { label: 'Date Pruned', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Notes', type: 'textarea', placeholder: 'e.g., Pruned runners...' }
                ],
                details: 'Log dates of vine pruning or maintenance.'
            },
            { id: 'harvest', step: 8, activity: 'Harvest Tubers', color: 'brown', offsetKey: 'daysToHarvest', durationDays: 0, icon: 'üß∫', phase: 'Harvesting', 
                logFields: [
                    { label: 'Harvest Date', type: 'date' },
                    { label: 'Field/Bed ID', type: 'text', placeholder: 'e.g., Bed 1-A' },
                    { label: 'Total Harvest (Kg)', type: 'number', placeholder: 'e.g., 12.5' }
                ], 
                details: 'Dig tubers when vines die back. Log your harvest metrics.' 
            }, 
            { id: 'cure', step: 9, activity: 'Start Curing', color: 'orange', offsetKey: 'daysToHarvest', durationDays: 10, icon: 'üî•', phase: 'Curing', 
                logFields: [
                    { label: 'Curing Start Date', type: 'date' },
                    { label: 'Location', type: 'text', placeholder: 'e.g., Curing Shed' },
                    { label: 'Avg. Temp (¬∞F)', type: 'number', placeholder: 'e.g., 80' }
                ], 
                details: 'Cure potatoes for 10 days in a warm, dark place to sweeten and heal skin.' 
            },
            { id: 'storage', step: 10, activity: 'Begin Storage/Sale', color: 'gray', offsetKey: 'daysToHarvest', durationDays: 10, fixedEndOffset: 10, icon: 'üì¶', phase: 'Storage', 
                logFields: [
                    { label: 'Storage Start Date', type: 'date' },
                    { label: 'Location', type: 'text', placeholder: 'e.g., Root Cellar' }
                ], 
                details: 'Move cured potatoes to cool, dry storage (55-60¬∞F).' 
            },
            { id: 'sale', step: 11, activity: 'Log Sale', color: 'green', icon: 'ü§ù', phase: 'Sales',
                logFields: [
                    { label: 'Sale Date', type: 'date' },
                    { label: 'Quantity Sold (Kg)', type: 'number', placeholder: 'e.g., 25' },
                    { label: 'Price per Kg ($)', type: 'number', placeholder: 'e.g., 1.50' },
                    { label: 'Customer/Market', type: 'text', placeholder: 'e.g., Farmer\'s Market' }
                ],
                details: 'Log sales data to track revenue.'
            }
        ];


        // --- DOM ELEMENT REFERENCES ---
        const contentArea = document.getElementById('content-area');
        const stepIcon = document.getElementById('step-icon');
        const stepTitle = document.getElementById('step-title');
        const stepDescription = document.getElementById('step-description');
        const stepActions = document.getElementById('step-actions');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const plannerTool = document.getElementById('planner-tool');
        const projectLogTool = document.getElementById('project-log-tool');
        const reportingTool = document.getElementById('reporting-tool');
        const reportOutput = document.getElementById('report-output');
        const progressContainer = document.getElementById('progress-container');
        const guideFooter = document.getElementById('guide-footer');

        const toggleGuideBtn = document.getElementById('toggle-guide-btn');
        const togglePlannerBtn = document.getElementById('toggle-planner-btn');
        const toggleLogBtn = document.getElementById('toggle-log-btn');
        const toggleReportingBtn = document.getElementById('toggle-reporting-btn');

        const plantingDateInput = document.getElementById('planting-date');
        const calendarOutput = document.getElementById('calendar-output');
        const assumptionInputs = document.getElementById('assumption-inputs');
        const addAllBtn = document.getElementById('add-all-btn');
        
        const logEntriesContainer = document.getElementById('log-entries');


        // --- STATE & UTILITIES ---
        let currentStep = 0;
        let activeView = 'guide'; // 'guide', 'planner', 'log', 'reporting'
        
        // NEW Data Structure: Log now holds multiple entries per step
        // projectLog = { 
        //   'step_id': { done: false, date: '', entries: [ { 'Field Label': 'value', ... }, ... ] } 
        // }
        let projectLog = {}; 
        
        const COLORS = {
            'orange': 'border-orange-500 bg-orange-100',
            'blue': 'border-blue-500 bg-blue-100',
            'green': 'border-green-500 bg-green-100',
            'brown': 'border-amber-700 bg-amber-100',
            'red': 'border-red-500 bg-red-100',
            'gray': 'border-gray-500 bg-gray-100',
        };

        // Helper: Format date as YYYYMMDD for Google Calendar
        function formatDateForGoogle(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        // Helper: Get Google Calendar URL for a single event
        function getGoogleCalendarUrl(startDate, activity, details, durationDays = 1, stepNumber) {
            const startStr = formatDateForGoogle(startDate);
            const endDate = new Date(startDate);
            // Google Calendar requires a date range (start day / end day)
            endDate.setDate(startDate.getDate() + durationDays);
            const endStr = formatDateForGoogle(endDate);
            
            const title = `Sweet Potato: ${activity}`;

            const baseUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
            const text = encodeURIComponent(title);
            const dates = `${startStr}/${endStr}`;
            const detailsText = encodeURIComponent(details + ` (Reference Guide Step ${stepNumber})`);

            return `${baseUrl}&text=${text}&dates=${dates}&details=${detailsText}`;
        }

        // Helper: Get Google Calendar URL for ALL events (iCal/Web Cal)
        function getBulkCalendarUrl(events) {
            const baseUrl = 'https.calendar.google.com/calendar/render?action=TEMPLATE';
            let bulkTitle = "Sweet Potato Full Project Plan";
            let bulkDetails = "Your full scheduled plan, calculated based on your Planting Date:\n";

            events.forEach((event, index) => {
                // Ensure eventDate is a date object
                const readableDate = new Date(event.startDate).toDateString();

                bulkDetails += `\n${index + 1}. ${event.activity}: ${readableDate}. Duration: ${event.durationDays ? event.durationDays + ' days' : '1 day'}.`;
            });

            // For simplicity, we create a single "Project Start" event with all dates in the details
            const today = new Date();
            const startStr = formatDateForGoogle(today);
            const endStr = formatDateForGoogle(today);
            
            const text = encodeURIComponent(bulkTitle);
            const dates = `${startStr}/${endStr}`;
            const detailsText = encodeURIComponent(bulkDetails);

            return `${baseUrl}&text=${text}&dates=${dates}&details=${detailsText}`;
        }

        // Helper to safely get value from assumption inputs
        const getAssumptionValue = (id) => {
            return parseFloat(document.getElementById(id)?.value) || 0;
        };

        // --- NEW: Collapsible Section Toggle ---
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.querySelector(`[data-controls="${sectionId}"] .chevron-icon`);
            
            if (content) {
                content.classList.toggle('hidden');
            }
            if (icon) {
                icon.classList.toggle('rotate-180');
            }
        }

        // --- SCHEDULING LOGIC (DYNAMICALLY GENERATED) ---
        
        function getDynamicSchedule() {
            const daysToHarvest = getAssumptionValue('daysToHarvest');
            const daysPropagation = getAssumptionValue('daysPropagation');
            const daysMotherStart = getAssumptionValue('daysMotherStart');
            const daysPrePlantingPrep = getAssumptionValue('daysPrePlantingPrep');
            
            // Calculate offsets based on user inputs
            const scheduleOffsets = {
                // Pre-Planting (offsets are calculated backward from Day 0 Planting)
                'start_mother': -(daysMotherStart + daysPropagation),
                'cut_slips': -daysPropagation - (daysMotherStart / 2), // Estimate cut slips halfway through sprouting
                'root_slips': -daysPropagation,
                'soil_prep': -daysPrePlantingPrep,
                
                // Growing Phase (Day 0 Planting)
                'plant_field': 0,
                'scouting_start': 30, // Fixed start day after planting
                'manage_vines': 45, // Set offset to 45 days post-planting
                
                // Post-Planting (offsets are calculated forward from Day 0 Planting)
                'harvest': daysToHarvest,
                'cure': daysToHarvest, // Curing starts on harvest day
                'storage': daysToHarvest + 10, // Storage starts 10 days after harvest/curing starts
                'sale': daysToHarvest + 10, // Sales can start after curing/storage begins
            };

            const dynamicSchedule = baseSchedule.map(event => {
                let offset = scheduleOffsets[event.id] || 0;
                let duration = event.durationDays;
                
                // Special Duration Overrides (if defined by user inputs)
                if (event.durationKey === 'daysMotherStart') duration = daysMotherStart;
                if (event.durationKey === 'daysPropagation') duration = daysPropagation;
                if (event.durationKey === 'daysPrePlantingPrep') duration = daysPrePlantingPrep;
                if (event.durationKey === 'daysToHarvest') duration = daysToHarvest;
                
                // Special case for scouting, which has fixed days in the baseSchedule definition
                if (event.id === 'scouting_start') duration = event.durationDays; 

                return {
                    ...event,
                    offsetDays: offset,
                    durationDays: duration
                };
            }).sort((a, b) => a.offsetDays - b.offsetDays); // Sort by calculated offset

            return dynamicSchedule;
        }

        function calculateAndRenderSchedule() {
            const plantingDateStr = plantingDateInput.value;
            if (!plantingDateStr) {
                calendarOutput.innerHTML = `<p class="text-gray-500 italic" id="planner-placeholder">
                    Enter a planting date above to see your full schedule.
                </p>`;
                addAllBtn.classList.add('hidden');
                return;
            }

            const plantingDate = new Date(plantingDateStr);
            // Ensure plantingDate is treated as the start of Day 0 in a fixed time context
            plantingDate.setUTCHours(0, 0, 0, 0); 
            
            const dynamicSchedule = getDynamicSchedule();
            let html = '<ul class="space-y-4">';
            let prevDate = null;
            let eventsWithDates = [];

            dynamicSchedule.forEach((event, index) => {
                // Skip events with no duration (like 'cut_slips' which is just for logging)
                if (event.durationKey === undefined && event.durationDays === undefined && event.fixedStartDays === undefined) {
                    // UPDATED: Check if logFields exist. If they do, but it's not a "duration" event (like sales), we should still show it.
                    // But we will still skip cut_slips as it's an intermittent logging activity.
                    if (event.id === 'cut_slips') return; 
                    if ((!event.logFields || event.logFields.length === 0)) return;
                }

                const eventDate = new Date(plantingDate);
                eventDate.setDate(plantingDate.getDate() + event.offsetDays);
                const readableDate = eventDate.toDateString();
                
                // Calculate days from previous event (only used for display, not logic)
                let daysDifference = '';
                if (prevDate) {
                    const diffTime = Math.abs(eventDate.getTime() - prevDate.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 0) {
                        daysDifference = `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full ml-3">Wait ${diffDays} days from previous step</span>`;
                    }
                }
                prevDate = eventDate;

                // Duration for Calendar is at least 1 day
                const duration = event.durationDays > 0 ? event.durationDays : 1; 

                const calendarUrl = getGoogleCalendarUrl(eventDate, event.activity, event.details, duration, event.step);
                const colorClass = COLORS[event.color] || 'border-gray-500 bg-gray-100';

                // Store event with calculated date for the bulk calendar link
                eventsWithDates.push({ ...event, startDate: eventDate, durationDays: duration });

                html += `
                    <li class="p-3 border-l-4 ${colorClass} rounded-md">
                        <div class="flex items-center justify-between">
                            <p class="font-bold text-lg text-gray-800 flex items-center">
                                ${event.icon} ${event.activity}
                            </p>
                            ${daysDifference}
                        </div>
                        <p class="text-sm text-gray-700 mt-1">
                            Date: <span class="font-semibold">${readableDate}</span>
                            <span class="ml-4 text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded-full">Phase: ${event.phase}</span>
                            <span class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">${event.durationDays > 0 ? event.durationDays + ' Day Duration' : 'Single Day Event'}</span>
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            <span class="font-medium">Details:</span> ${event.details}
                        </p>
                        <a href="${calendarUrl}" target="_blank" class="mt-2 inline-block text-xs font-bold text-blue-600 hover:text-blue-800 transition duration-150">
                            + Add Single Event to Calendar
                        </a>
                    </li>
                `;
            });

            html += '</ul>';
            calendarOutput.innerHTML = html;
            
            // Update the Add All button event handler with the calculated dates
            addAllBtn.onclick = () => {
                window.open(getBulkCalendarUrl(eventsWithDates), '_blank');
            };
            addAllBtn.classList.remove('hidden');
        }

        // --- ACTIVITY LOG LOGIC (REFACTORED) ---
        
        function renderLog() {
            let html = '';
            steps.forEach((step, index) => {
                // Find corresponding schedule data for log fields
                const logData = baseSchedule.find(d => d.step === index + 1);
                
                // Skip steps that have no loggable fields (like 7, 9, 10, 11)
                // UPDATED: This check is now dynamic based on logFields.
                if (!logData || !logData.logFields || logData.logFields.length === 0) return; 

                const stepLog = projectLog[step.id] || { done: false, date: '', entries: [] };
                
                // Render the individual entries for this step
                let entriesHtml = '<div class="space-y-3 mt-4">';
                stepLog.entries.forEach((entry, entryIndex) => {
                    entriesHtml += renderLogEntry(step.id, entryIndex, logData.logFields, entry);
                });
                entriesHtml += '</div>';

                const contentId = `log-content-${step.id}`;

                html += `
                    <div class="p-4 activity-log-card bg-white rounded-lg border-l-4 ${stepLog.done ? 'border-green-600' : 'border-gray-300'}">
                        <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('${contentId}')" data-controls="${contentId}">
                            <p class="font-bold text-gray-700">${step.visual.replace(/‚Üí/g, '‚Üí')} Step ${index + 1}: ${step.title}</p>
                            <div class="flex items-center">
                                <label class="flex items-center space-x-2 mr-4" onclick="event.stopPropagation();">
                                    <input type="checkbox" ${stepLog.done ? 'checked' : ''} onchange="toggleDone('${step.id}', this.checked)" class="h-5 w-5 text-green-600 rounded">
                                    <span class="text-sm font-medium text-gray-600">Done</span>
                                </label>
                                <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                        </button>
                        
                        <div id="${contentId}" class="collapsible-content mt-4">
                            <label for="${step.id}-date" class="block text-sm font-medium text-gray-700 mt-2">Overall Completion Date (for this step):</label>
                            <input type="date" id="${step.id}-date" value="${stepLog.date}" onchange="updateDate('${step.id}', this.value)" class="p-2 border rounded-md shadow-inner w-full mb-3 text-sm">
                            
                            <h5 class="font-semibold text-gray-700 mt-4 border-t pt-3">Data Entries:</h5>
                            ${entriesHtml}
                            
                            <button onclick="addLogEntry('${step.id}')" class="mt-4 w-full btn-secondary py-2 text-sm rounded-lg font-semibold">
                                + Add New Entry for Step ${index + 1}
                            </button>
                            <p id="${step.id}-status" class="text-xs text-green-600 mt-2 font-medium"></p>
                        </div>
                    </div>
                `;
            });

            logEntriesContainer.innerHTML = html;

            // Update status messages after rendering (important for dynamic content)
            for (const key in projectLog) {
                const statusElement = document.getElementById(`${key}-status`);
                if (statusElement && projectLog[key].done) {
                    const dateText = projectLog[key].date || 'N/A';
                    statusElement.textContent = `Step marked complete on: ${dateText}.`;
                }
            }
        }

        function renderLogEntry(stepId, entryIndex, logFields, entryData) {
            let fieldsHtml = '';
            logFields.forEach(field => {
                const value = entryData[field.label] || '';
                const placeholder = field.placeholder || `Enter ${field.label}`;
                if (field.type === 'textarea') {
                    fieldsHtml += `
                        <label class="block text-sm font-medium text-gray-700">${field.label}:</label>
                        <textarea onchange="updateLogEntry('${stepId}', ${entryIndex}, '${field.label}', this.value)"
                            placeholder="${placeholder}"
                            class="p-2 border rounded-md shadow-inner w-full mb-2 text-sm">${value}</textarea>
                    `;
                } else {
                    fieldsHtml += `
                        <label class="block text-sm font-medium text-gray-700">${field.label}:</label>
                        <input type="${field.type}" value="${value}" 
                            onchange="updateLogEntry('${stepId}', ${entryIndex}, '${field.label}', this.value)"
                            placeholder="${placeholder}" 
                            class="p-2 border rounded-md shadow-inner w-full mb-2 text-sm">
                    `;
                }
            });

            return `
                <div class="p-3 bg-gray-50 rounded-lg border log-entry-card">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold text-gray-600">Entry ${entryIndex + 1}</p>
                        <button onclick="removeLogEntry('${stepId}', ${entryIndex})" 
                            class="text-xs text-red-600 font-semibold hover:text-red-800">
                            Remove
                        </button>
                    </div>
                    ${fieldsHtml}
                </div>
            `;
        }

        function addLogEntry(stepId) {
            projectLog[stepId] = projectLog[stepId] || { done: false, date: '', entries: [] };
            
            const logData = baseSchedule.find(d => d.step === steps.findIndex(s => s.id === stepId) + 1);
            if (!logData) return;

            const newEntry = {};
            logData.logFields.forEach(field => {
                newEntry[field.label] = ''; // Initialize with empty values
            });

            projectLog[stepId].entries.push(newEntry);
            renderLog(); // Re-render the log to show the new entry form
        }

        function removeLogEntry(stepId, entryIndex) {
            const stepLog = projectLog[stepId];
            if (stepLog && stepLog.entries[entryIndex]) {
                stepLog.entries.splice(entryIndex, 1);
                renderLog(); // Re-render
            }
        }

        function updateLogEntry(stepId, entryIndex, label, value) {
            const entry = projectLog[stepId]?.entries[entryIndex];
            if (entry) {
                entry[label] = value;
                // Data is saved in the projectLog object, no need to re-render just for a value change
            }
        }

        function toggleDone(id, isChecked) {
            projectLog[id] = projectLog[id] || { done: false, date: '', entries: [] };
            projectLog[id].done = isChecked;
            if (isChecked && !projectLog[id].date) {
                // Set today's date if marked done but no date exists
                projectLog[id].date = new Date().toISOString().substring(0, 10);
            } 
            renderLog();
        }

        function updateDate(id, dateValue) {
            projectLog[id] = projectLog[id] || { done: false, date: '', entries: [] };
            projectLog[id].date = dateValue;
            if (dateValue && !projectLog[id].done) {
                // Mark done if a date is manually entered
                projectLog[id].done = true;
            } 
            renderLog();
        }


        // --- REPORTING LOGIC ---
        function renderReport(isRefresh = false) {
            if (!isRefresh && Object.keys(projectLog).length === 0) {
                // Only show placeholder if not a manual refresh AND there is no data
                reportOutput.innerHTML = `<p class="text-gray-500 italic">Click "Refresh Report" to see your project data.</p>`;
                return;
            }

            // Calculations
            const mothers = projectLog['start_mother']?.entries || [];
            const slipsCut = projectLog['cut_slips']?.entries || [];
            const slipsRooted = projectLog['root_slips']?.entries || [];
            const slipsPlanted = projectLog['plant_field']?.entries || [];
            const soilTests = projectLog['soil_prep']?.entries || [];
            const pestSightings = projectLog['scouting_start']?.entries || []; // Corrected ID
            const harvests = projectLog['harvest']?.entries || [];
            const sales = projectLog['sale']?.entries || []; // NEW: Get sales data

            // Totals
            const totalMothers = mothers.length;
            const totalSlipsCut = slipsCut.reduce((sum, entry) => sum + (parseFloat(entry['Slips Cut']) || 0), 0);
            const totalSlipsRooted = slipsRooted.reduce((sum, entry) => sum + (parseFloat(entry['Slips Put in Water']) || 0), 0);
            const totalSlipsPlanted = slipsPlanted.reduce((sum, entry) => sum + (parseFloat(entry['Slips Planted']) || 0), 0);
            const totalHarvestKg = harvests.reduce((sum, entry) => sum + (parseFloat(entry['Total Harvest (Kg)']) || 0), 0);
            const totalSoldKg = sales.reduce((sum, entry) => sum + (parseFloat(entry['Quantity Sold (Kg)']) || 0), 0); // NEW
            const totalRevenue = sales.reduce((sum, entry) => { // NEW
                const qty = parseFloat(entry['Quantity Sold (Kg)']) || 0;
                const price = parseFloat(entry['Price per Kg ($)']) || 0;
                return sum + (qty * price);
            }, 0);

            // Calculate Averages
            const avgPH = soilTests.length > 0 
                ? (soilTests.reduce((sum, entry) => sum + (parseFloat(entry['Soil pH']) || 0), 0) / soilTests.length).toFixed(2)
                : 'N/A';
            
            const avgHarvestPerPlanting = harvests.length > 0
                ? (totalHarvestKg / harvests.length).toFixed(2)
                : 'N/A';
            
            const avgPricePerKg = totalSoldKg > 0 // NEW
                ? (totalRevenue / totalSoldKg).toFixed(2)
                : 'N/A';
            
            // Build Report HTML
            let html = `
                <h4 class="text-2xl font-bold text-gray-800 mb-4">Project Summary Report</h4>
                
                <!-- Summary Metrics -->
                <div class="report-section bg-gray-50 p-4 rounded-lg mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-totals')" data-controls="report-totals">
                        <h5 class="text-xl font-semibold text-gray-700">Key Totals</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-totals" class="collapsible-content mt-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-orange-600">${totalMothers}</p>
                                <p class="text-sm font-medium text-gray-600">Mother Tubers</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-blue-600">${totalSlipsCut}</p>
                                <p class="text-sm font-medium text-gray-600">Slips Cut</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-600">${totalSlipsPlanted}</p>
                                <p class="text-sm font-medium text-gray-600">Slips Planted</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-yellow-700">${totalHarvestKg.toFixed(1)} Kg</p>
                                <p class="text-sm font-medium text-gray-600">Total Harvest</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Financial Metrics -->
                <div class="report-section bg-gray-50 p-4 rounded-lg mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-financials')" data-controls="report-financials">
                        <h5 class="text-xl font-semibold text-gray-700">Financial Summary</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-financials" class="collapsible-content mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-600">$${totalRevenue.toFixed(2)}</p>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-700">${totalSoldKg.toFixed(1)} Kg</p>
                                <p class="text-sm font-medium text-gray-600">Total Kg Sold</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg shadow-sm border">
                                <p class="text-3xl font-bold text-green-800">$${avgPricePerKg}</p>
                                <p class="text-sm font-medium text-gray-600">Avg. Price / Kg</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Propagation Funnel -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-funnel')" data-controls="report-funnel">
                        <h5 class="text-xl font-semibold text-gray-700">Propagation Funnel</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-funnel" class="collapsible-content mt-4">
                        <div class="flex flex-col md:flex-row gap-2 text-center items-center">
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <p class="text-2xl font-bold">${totalSlipsCut}</p>
                                <p class="text-sm font-medium">Slips Cut</p>
                            </div>
                            <p class="text-2xl font-bold text-gray-400 mx-2">‚Üí</p>
                            <div class="p-3 bg-blue-200 rounded-lg">
                                <p class="text-2xl font-bold">${totalSlipsRooted}</p>
                                <p class="text-sm font-medium">Slips Rooted</p>
                            </div>
                            <p class="text-2xl font-bold text-gray-400 mx-2">‚Üí</p>
                            <div class="p-3 bg-green-200 rounded-lg">
                                <p class="text-2xl font-bold">${totalSlipsPlanted}</p>
                                <p class="text-sm font-medium">Slips Planted</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Harvest Details -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-harvest')" data-controls="report-harvest">
                        <h5 class="text-xl font-semibold text-gray-700">Harvest Log (Total: ${totalHarvestKg.toFixed(1)} Kg, Avg: ${avgHarvestPerPlanting} Kg/Entry)</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-harvest" class="collapsible-content mt-4">
                        ${createTableHtml(harvests, ['Harvest Date', 'Field/Bed ID', 'Total Harvest (Kg)'])}
                    </div>
                </div>

                <!-- Pest Log -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-pest')" data-controls="report-pest">
                        <h5 class="text-xl font-semibold text-gray-700">Pest & Disease Log (${pestSightings.length} sightings)</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-pest" class="collapsible-content mt-4">
                        ${createTableHtml(pestSightings, ['Date Sighted', 'Pest/Disease Name', 'GPS (Lat, Lon)', 'Notes/Action Taken'])}
                    </div>
                </div>

                <!-- Soil Tests -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-soil')" data-controls="report-soil">
                        <h5 class="text-xl font-semibold text-gray-700">Soil Test Log (Avg. pH: ${avgPH})</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-soil" class="collapsible-content mt-4">
                        ${createTableHtml(soilTests, ['Date Tested', 'Field/Bed ID', 'Soil pH'])}
                    </div>
                </div>

                <!-- NEW: Sales Log -->
                <div class="report-section mb-6">
                    <button class="flex items-center justify-between w-full text-left" onclick="toggleSection('report-sales')" data-controls="report-sales">
                        <h5 class="text-xl font-semibold text-gray-700">Sales Log (Total: $${totalRevenue.toFixed(2)})</h5>
                        <svg class="chevron-icon w-5 h-5 text-gray-600" data-icon="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div id="report-sales" class="collapsible-content mt-4">
                        ${createTableHtml(sales, ['Sale Date', 'Quantity Sold (Kg)', 'Price per Kg ($)', 'Customer/Market'])}
                    </div>
                </div>
            `;

            reportOutput.innerHTML = html;
        }

        function createTableHtml(data, headers) {
            if (data.length === 0) {
                return '<p class="text-gray-500 italic">No data logged for this category.</p>';
            }
            
            let table = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            // Header
            table += '<thead class="bg-gray-50"><tr>';
            headers.forEach(header => {
                table += `<th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`;
            });
            table += '</tr></thead>';
            
            // Body
            table += '<tbody class="bg-white divide-y divide-gray-200">';
            data.forEach(entry => {
                table += '<tr>';
                headers.forEach(header => {
                    table += `<td class="px-4 py-3 whitespace-nowLrap text-sm text-gray-700">${entry[header] || ''}</td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        function downloadReport() {
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectLog, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "sweet_potato_log.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            } catch (error) {
                console.error("Failed to download JSON:", error);
                // We can't use alert(), so we'll log to console
            }
        }


        // --- UI VIEW MANAGEMENT ---

        function setView(viewName) {
            activeView = viewName;

            // Hide all content areas
            contentArea.classList.add('hidden');
            stepActions.classList.add('hidden');
            plannerTool.classList.add('hidden');
            projectLogTool.classList.add('hidden');
            reportingTool.classList.add('hidden');
            progressContainer.classList.add('hidden');
            guideFooter.classList.add('hidden');

            // Reset button styles
            toggleGuideBtn.className = 'flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm';
            togglePlannerBtn.className = 'flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm';
            toggleLogBtn.className = 'flex-1 btn-secondary px-4 py-2 rounded-lg font-bold text-sm';
            toggleReportingBtn.className = 'col-span-3 mt-2 flex-1 btn-tertiary px-4 py-2 rounded-lg font-bold text-sm';


            // Show active content area and set button style
            if (viewName === 'guide') {
                contentArea.classList.remove('hidden');
                progressContainer.classList.remove('hidden');
                guideFooter.classList.remove('hidden');
                stepActions.classList.remove('hidden');
                toggleGuideBtn.className = 'flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm';
                renderStep();
            } else if (viewName === 'planner') {
                plannerTool.classList.remove('hidden');
                togglePlannerBtn.className = 'flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm';
                calculateAndRenderSchedule();
            } else if (viewName === 'log') {
                projectLogTool.classList.remove('hidden');
                toggleLogBtn.className = 'flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm';
                renderLog();
            } else if (viewName === 'reporting') {
                reportingTool.classList.remove('hidden');
                toggleReportingBtn.className = 'col-span-3 mt-2 flex-1 btn-primary px-4 py-2 rounded-lg font-bold text-sm';
                renderReport(true); // Render report immediately
            }
        }
        
        // --- GUIDE RENDERING LOGIC ---

        function renderStep() {
            contentArea.style.opacity = '0';
            setTimeout(() => {
                const step = steps[currentStep];
                const stepNum = currentStep + 1;
                
                // Render the clean visual symbols
                stepIcon.innerHTML = `<p class="text-5xl font-extrabold text-gray-800">${step.visual.replace(/‚Üí/g, '<span class="text-4xl mx-2 text-orange-500">‚Üí</span>')}</p>`;
                
                stepTitle.textContent = step.title;
                
                // Directly set the description (now that the source data is clean)
                stepDescription.innerHTML = `<p class="mb-3">${step.description.replace(/\n\n/g, '</p><p class="mb-3">')}</p>`;
                
                // Render Action Buttons
                stepActions.innerHTML = `
                    <button onclick="setView('planner')" class="link-btn mr-3">
                        View Date in Planner
                    </button>
                    <button onclick="setView('log')" class="link-btn">
                        Log Step ${stepNum} Completion
                    </button>
                `;

                const progressPercentage = (stepNum / steps.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `Guide Step ${stepNum} of ${steps.length}`;

                prevBtn.disabled = currentStep === 0;
                prevBtn.classList.toggle('opacity-50', currentStep === 0);

                if (currentStep === steps.length - 1) {
                    nextBtn.textContent = 'Guide Complete! üéâ';
                    nextBtn.classList.remove('btn-primary');
                    nextBtn.classList.add('btn-secondary');
                } else {
                    nextBtn.textContent = 'Next Step ‚Üí';
                    nextBtn.classList.remove('btn-secondary');
                    nextBtn.classList.add('btn-primary');
                }

                contentArea.style.opacity = '1';
            }, 300);
        }

        // --- NAVIGATION HANDLERS ---
        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep();
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }
        
        // --- EVENT LISTENERS ---

        // Navigation
        prevBtn.addEventListener('click', prevStep);
        nextBtn.addEventListener('click', nextStep);
        
        // View Toggles
        toggleGuideBtn.addEventListener('click', () => setView('guide'));
        togglePlannerBtn.addEventListener('click', () => setView('planner'));
        toggleLogBtn.addEventListener('click', () => setView('log'));
        toggleReportingBtn.addEventListener('click', () => setView('reporting'));

        // --- INITIALIZATION ---
        window.onload = () => {
            setView('guide'); // Start on the guide page
            // Add listener for download button
            // We must add it here because the button is part of the reporting-tool div
            const downloadBtn = document.getElementById('download-json-btn');
            if(downloadBtn) {
                downloadBtn.addEventListener('click', downloadReport);
            }
        };
        
    </script>
</body>
</html>


